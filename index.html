<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Jeico Streaming | Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  


<style id="style-style.css">/* style.css */
/* =========================================
   ESTILOS CLIENTE - THEME GOTH (DARKNESS & PURPLE) - FIXED
   ========================================= */
@import url('https://fonts.googleapis.com/css2?family=Righteous&family=Inter:wght@300;400;600;800&display=swap');

:root {
  /* Paleta Goth */
  --bg-dark: #000000;       /* Negro Puro */
  --bg-card: #0a0a0a;       /* Casi Negro */
  --bg-sidebar: #050505;    /* Negro Profundo */
  --border-color: #1f1f1f;  /* Bordes sutiles */
  
  --accent: #7c3aed;        /* Violeta Oscuro Místico */
  --accent-hover: #6d28d9;  /* Violeta más intenso */
  --accent-glow: rgba(124, 58, 237, 0.4); /* Glow suavizado */
  
  --text-white: #e5e5e5;    /* Blanco Hueso */
  --text-gray: #737373;     /* Gris neutro */
  
  --success: #059669;       /* Verde Esmeralda oscuro */
  --danger: #9f1239;        /* Rojo Sangre */
  
  --sidebar-w: 260px;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
body { background-color: var(--bg-dark); color: var(--text-white); overflow-x: hidden; }

/* --- HERO SECTION (CORREGIDA - ELEGANTE) --- */
.hero-container {
    /* Fondo negro con un resplandor superior sutil, nada de azules chillones */
    background: radial-gradient(circle at top, #1a0b2e 0%, #000000 80%);
    color: white;
    text-align: center;
    padding: 80px 20px;
    border-radius: 20px;
    margin-bottom: 50px;
    border: 1px solid var(--border-color);
    box-shadow: 0 0 50px rgba(0,0,0,0.5); /* Sombra difusa */
}

/* =========================================================
   MEJORA: TÍTULO HERO "ENTRETENIMIENTO SIN LÍMITES"
   ========================================================= */
.hero-content h1 {
    font-family: 'Righteous', cursive;
    /* Tamaño reducido: Mínimo 2rem, ideal 4.5vw, máximo 3.2rem */
    font-size: clamp(2rem, 4.5vw, 3.2rem); 
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 2px;
    line-height: 1.2;
    margin-bottom: 20px;
    
    /* Efecto Gradiente Premium Animado */
    background: linear-gradient(to right, #ffffff 20%, #a855f7 50%, #7c3aed 80%, #ffffff 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    
    /* Sombra exterior (Glow) y Animación */
    filter: drop-shadow(0px 6px 12px rgba(124, 58, 237, 0.4));
    animation: shineHeroText 5s linear infinite;
}

/* Animación que hace que el color fluya por el texto */
@keyframes shineHeroText {
    to {
        background-position: 200% center;
    }
}

/* Pequeño ajuste al texto de abajo para que acompañe el nivel del título */
.hero-content p {
    font-size: 1rem; /* También lo reduje un poquito para que encaje mejor */
    color: #a3a3a3;
    max-width: 600px;
    margin: 0 auto 30px auto;
    line-height: 1.6;
    font-weight: 400;
}

.cta-button {
    /* Coherencia: Usamos el accent violeta, no el cian */
    background: var(--accent); 
    color: white;
    padding: 16px 40px;
    text-decoration: none;
    font-weight: 700;
    border-radius: 4px; /* Bordes menos redondos para estilo serio */
    transition: all 0.3s ease;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 1px;
    border: 1px solid var(--accent);
    box-shadow: 0 0 15px var(--accent-glow);
}

.cta-button:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 0 30px var(--accent-glow);
    color: #fff;
}

.features-grid {
    display: flex;
    justify-content: center;
    gap: 30px;
    flex-wrap: wrap;
    margin-top: 50px;
}

.feature-card {
    /* Tarjetas sólidas y oscuras, se leen mejor que el vidrio borroso */
    background: #0a0a0a; 
    padding: 30px;
    border-radius: 10px;
    width: 280px;
    border: 1px solid #222;
    transition: transform 0.3s, border-color 0.3s;
}

.feature-card:hover { 
    transform: translateY(-5px); 
    border-color: var(--accent); 
}

.feature-icon { 
    font-size: 2rem; 
    margin-bottom: 15px; 
    display: block; 
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); /* Iconos con brillo sutil */
}

.feature-title { 
    font-weight: 700; 
    color: #fff; /* Título blanco limpio */
    margin-bottom: 10px; 
    display: block; 
    font-size: 1.1rem; 
    text-transform: uppercase;
}

.feature-desc { 
    font-size: 0.9rem; 
    color: #666; /* Descripción en gris oscuro para no saturar */
    line-height: 1.4;
}

.section-subtitle {
    font-family: 'Righteous'; 
    color: var(--accent); 
    font-size: 1.8rem; 
    margin-bottom: 30px; 
    text-transform: uppercase;
    border-left: 4px solid var(--accent);
    padding-left: 15px;
    letter-spacing: 1px;
}

/* --- ESTILOS GENERALES Y LOGIN --- */
.hidden { display: none !important; }
.overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 900; }

#login-view { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #000 0%, #11001c 100%); }
.login-box { width: 100%; max-width: 400px; padding: 40px; background: #0a0a0a; border: 1px solid var(--border-color); border-radius: 4px; text-align: center; box-shadow: 0 0 30px rgba(124, 58, 237, 0.1); }
.login-logo { font-family: 'Righteous'; font-size: 2.5rem; color: #fff; margin-bottom: 30px; letter-spacing: 3px; text-shadow: 0 0 10px var(--accent); }
.input-field { width: 100%; padding: 14px; background: #000; border: 1px solid var(--border-color); border-radius: 4px; color: white; margin-bottom: 20px; outline: none; transition: 0.3s; }
.input-field:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
.btn-login { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 4px; font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
.btn-login:hover { background: var(--accent-hover); box-shadow: 0 0 20px var(--accent-glow); }

#app-view { display: none; min-height: 100vh; }

/* Sidebar */
.sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); height: 100vh; position: fixed; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); z-index: 100; overflow-y: auto; }
.brand { padding: 40px 20px; text-align: center; font-family: 'Righteous'; font-size: 2rem; color: white; letter-spacing: 2px; text-shadow: 0 0 15px var(--accent); }
.nav-links { list-style: none; padding: 20px; flex-grow: 1; }
.nav-item { display: flex; align-items: center; gap: 15px; padding: 16px 20px; color: var(--text-gray); border-radius: 0; margin-bottom: 5px; transition: 0.3s; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; }
.nav-item:hover { color: white; border-left: 3px solid var(--accent); background: linear-gradient(90deg, rgba(124,58,237,0.1), transparent); }
.nav-item.active { color: var(--accent); border-left: 3px solid var(--accent); background: linear-gradient(90deg, rgba(124,58,237,0.2), transparent); }
.user-info { padding: 25px; border-top: 1px solid var(--border-color); background: #000; }
.user-name { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.95rem; color: #fff; }
.user-balance { color: var(--success); font-weight: 800; font-size: 1.1rem; text-shadow: 0 0 10px rgba(5, 150, 105, 0.4); }

/* Main Content */
.main-content { margin-left: var(--sidebar-w); flex-grow: 1; padding: 40px; position: relative; }
.page-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 40px; letter-spacing: -1px; text-transform: uppercase; background: linear-gradient(to right, #fff, #666); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

/* Grid Productos */
.products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 40px; }
.product-card { background: var(--bg-card); border: 1px solid var(--border-color); transition: 0.3s; display: flex; flex-direction: column; position: relative; height: 420px; }
.product-card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 40px rgba(0,0,0,0.8); }

.card-img-container { height: 55%; width: 100%; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, #1a1a1a 0%, #0a0a0a 70%); border-bottom: 1px solid var(--border-color); position: relative; overflow: hidden; }
.card-img { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 20px rgba(0,0,0,0.8); transition: 0.3s; border: 2px solid #222; }
.product-card:hover .card-img { transform: scale(1.1); border-color: var(--accent); }

.card-body { padding: 20px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; background: #080808; }
.card-title { font-weight: 700; font-size: 1rem; text-transform: uppercase; color: #fff; margin-bottom: 5px; letter-spacing: 0.5px; }
.card-stock { font-size: 0.75rem; color: var(--text-gray); margin-bottom: 10px; }
.price-container { margin: 10px 0 15px 0; }
.card-price { font-size: 1.4rem; color: var(--accent); font-weight: 800; text-shadow: 0 0 10px var(--accent-glow); }

.btn-buy { width: 100%; padding: 12px; border: 1px solid var(--accent); background: transparent; color: var(--accent); font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.85rem; transition: 0.3s; letter-spacing: 1px; }
.btn-buy:hover { background: var(--accent); color: white; box-shadow: 0 0 15px var(--accent-glow); }

/* PRODUCTO AGOTADO */
.product-card.sold-out { opacity: 0.6; filter: grayscale(1); border-color: #333 !important; }
.product-card.sold-out:hover { transform: none; box-shadow: none; }
.product-card.sold-out .card-img { border-color: #444; }
.product-card.sold-out .card-price { color: #666; text-shadow: none; }
.btn-buy.disabled { border-color: #444; color: #666; cursor: not-allowed; background: #111; }
.btn-buy.disabled:hover { box-shadow: none; color: #666; background: #111; }

/* Cart Drawer & Button */
.floating-cart-btn { position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: white; width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px var(--accent-glow); cursor: pointer; z-index: 800; transition: 0.3s; border: none; }
.floating-cart-btn:hover { transform: scale(1.1); background: var(--accent-hover); }
.cart-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 25px; height: 25px; border-radius: 50%; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-dark); }

.cart-drawer { position: fixed; top: 0; right: -400px; width: 350px; height: 100vh; background: #080808; border-left: 1px solid var(--border-color); z-index: 1000; transition: right 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; box-shadow: -10px 0 50px rgba(0,0,0,0.8); }
.cart-drawer.open { right: 0; }
.drawer-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #050505; }
.drawer-header h2 { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
.btn-close-drawer { background: none; border: none; color: #fff; cursor: pointer; }
.drawer-body { flex-grow: 1; padding: 20px; overflow-y: auto; }
.cart-item-row { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
.cart-item-img { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; border: 1px solid #333; }
.cart-item-info h4 { font-size: 0.9rem; margin-bottom: 5px; }
.cart-item-info span { font-size: 0.8rem; color: var(--text-gray); }
.cart-item-price { color: var(--accent); font-weight: bold; }
.btn-remove { color: var(--danger); background: none; border: none; cursor: pointer; font-size: 0.8rem; margin-top: 5px; }
.drawer-footer { padding: 25px; border-top: 1px solid var(--border-color); background: #050505; }
.drawer-total { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; }
.btn-checkout { width: 100%; padding: 15px; background: var(--success); color: white; border: none; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: 0.3s; letter-spacing: 1px; }
.btn-continue { width: 100%; padding: 12px; background: transparent; color: var(--text-gray); border: 1px solid var(--border-color); margin-top: 10px; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; transition: 0.3s; }
.btn-continue:hover { border-color: #fff; color: #fff; }

/* Checkout Modal */
.checkout-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); width: 90%; max-width: 600px; background: #0a0a0a; border: 1px solid var(--border-color); z-index: 1100; padding: 0; box-shadow: 0 0 50px rgba(0,0,0,0.8); opacity: 0; pointer-events: none; transition: 0.3s; }
.checkout-modal.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
.checkout-header { background: var(--accent); padding: 15px 25px; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
.checkout-body { padding: 30px; max-height: 60vh; overflow-y: auto; }
.checkout-summary-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 10px 0; }
.checkout-total-row { display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: 800; color: var(--accent); margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
.checkout-actions { padding: 20px; display: flex; gap: 15px; background: #050505; }
.btn-final-pay { flex: 1; background: var(--success); color: white; border: none; padding: 15px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
.btn-final-cancel { flex: 1; background: #222; color: #fff; border: none; padding: 15px; font-weight: 600; cursor: pointer; text-transform: uppercase; }

/* Submenu & Wallet */
.submenu { list-style: none; padding-left: 20px; margin-bottom: 10px; overflow: hidden; transition: max-height 0.3s ease-out; }
.submenu.hidden { display: none; }
.submenu-item { padding: 12px 15px; color: var(--text-gray); font-size: 0.8rem; border-radius: 0; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; border-left: 1px solid #333; text-transform: uppercase; letter-spacing: 1px; }
.submenu-item:hover { background: rgba(255,255,255,0.05); color: white; border-color: var(--accent); }
.arrow-icon { transition: transform 0.3s; }
.nav-item.open .arrow-icon { transform: rotate(180deg); }

.wallet-card { background: linear-gradient(135deg, #4f46e5 0%, #a855f7 100%); padding: 40px; border-radius: 24px; text-align: center; color: white; box-shadow: 0 20px 50px rgba(79, 70, 229, 0.3); margin-bottom: 30px; position: relative; overflow: hidden; }
.wallet-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none; }
.wallet-label { font-size: 1rem; font-weight: 500; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
.wallet-amount { font-size: 4rem; font-weight: 800; margin: 10px 0 30px 0; font-family: 'Inter', sans-serif; text-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.wallet-actions { display: flex; justify-content: center; gap: 15px; }
.btn-wallet-action { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 50px; font-weight: 600; cursor: pointer; backdrop-filter: blur(5px); transition: 0.3s; display: flex; align-items: center; gap: 8px; }
.btn-wallet-action:hover { background: white; color: #4f46e5; }

.orders-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
.orders-table th { text-align: left; padding: 15px; color: var(--text-gray); border-bottom: 1px solid #333; text-transform: uppercase; font-size: 0.8rem; }
.orders-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.orders-table tr:hover { background: rgba(255,255,255,0.02); }

/* Responsive */
@media(max-width: 768px) {
  .sidebar { width: 100%; height: auto; position: relative; padding: 10px; }
  .nav-links { display: none; } 
  .main-content { margin-left: 0; padding: 20px; }
  .cart-drawer { width: 85%; }
  .hero-content h1 { font-size: 1.8rem; }
  .features-grid { flex-direction: column; align-items: center; }
}
/* Añade o actualiza esto en tu style.css */

/* El carrito ahora tiene una transición para aparecer suavemente */
.floating-cart-btn {
    transition: transform 0.3s, opacity 0.3s, background 0.3s;
}

.floating-cart-btn.hidden {
    display: none !important; /* Forzamos desaparición */
}

/* Ajuste para que el Hero ocupe bien el espacio en el nuevo Inicio */
#sec-inicio {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Estilo para los iconos de material que faltaban en el menú */
.nav-item .material-icons-round {
    font-size: 1.3rem;
}
/* =========================================
   ESTILOS PREMIUM - HISTORIAL DE COMPRAS
   ========================================= */

.page-header-premium {
    margin-bottom: 40px;
}

.page-subtitle {
    color: var(--text-gray);
    font-size: 0.9rem;
    margin-top: -30px;
    letter-spacing: 1px;
}

.orders-premium-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 25px;
}

/* Tarjeta Estilo Cristal Goth */
.order-premium-card {
    background: linear-gradient(145deg, #0a0a0a 0%, #050505 100%);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 25px;
    position: relative;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    overflow: hidden;
}

.order-premium-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at top right, rgba(124, 58, 237, 0.1), transparent);
    pointer-events: none;
}

.order-premium-card:hover {
    transform: translateY(-10px) scale(1.02);
    border-color: var(--accent);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6), 0 0 20px var(--accent-glow);
}

/* Encabezado de la Tarjeta */
.card-order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    border-bottom: 1px solid #111;
    padding-bottom: 15px;
}

.service-badge {
    font-family: 'Righteous';
    font-size: 1.2rem;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.status-dot {
    width: 8px;
    height: 8px;
    background: var(--success);
    border-radius: 50%;
    display: inline-block;
    box-shadow: 0 0 10px var(--success);
    margin-right: 5px;
}

/* Cuerpo de la Tarjeta (Credenciales) */
.card-order-body {
    background: #000;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #111;
    margin-bottom: 20px;
}

.cred-label {
    font-size: 0.7rem;
    color: var(--text-gray);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

.cred-value {
    font-family: 'monospace';
    color: var(--accent);
    font-size: 0.95rem;
    word-break: break-all;
    line-height: 1.6;
}

/* Pie de Tarjeta */
.card-order-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.order-date-premium {
    font-size: 0.75rem;
    color: #444;
}

.btn-copy-premium {
    background: var(--accent);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s;
}

.btn-copy-premium:hover {
    background: var(--accent-hover);
    transform: rotate(-10deg) scale(1.1);
    box-shadow: 0 0 15px var(--accent-glow);
}

/* Responsive */
@media (max-width: 768px) {
    .orders-premium-grid { grid-template-columns: 1fr; }
}
/* --- GRID DE PRODUCTOS PREMIUM (RECTANGULAR) --- */
.products-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 30px; 
    padding: 20px 0;
}

.product-card {
    background: #0a0a0a; 
    border: 1px solid #1a1a1a; 
    border-radius: 12px; /* Bordes ligeramente redondeados */
    transition: all 0.4s ease; 
    display: flex; 
    flex-direction: column; 
    position: relative;
    height: 480px; /* Altura fija para alineación perfecta */
    overflow: hidden;
}

.product-card:hover {
    transform: translateY(-10px);
    border-color: var(--accent);
    box-shadow: 0 10px 30px rgba(0,0,0,1), 0 0 20px var(--accent-glow);
}

/* MITAD SUPERIOR: IMAGEN RECTANGULAR */
.card-img-container {
    height: 50%; /* Ocupa exactamente la mitad */
    width: 100%;
    overflow: hidden;
    background: #111;
    position: relative;
}

.card-img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* La imagen llena el espacio sin deformarse */
    transition: transform 0.6s ease;
}

.product-card:hover .card-img {
    transform: scale(1.1); /* Efecto zoom suave al pasar el mouse */
}

/* MITAD INFERIOR: CONTENIDO */
.card-body { 
    padding: 25px; 
    text-align: center; 
    flex-grow: 1; 
    display: flex; 
    flex-direction: column; 
    justify-content: space-between; 
    background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%);
}

.card-title { 
    font-family: 'Righteous', cursive;
    font-weight: 400; 
    font-size: 1.2rem; 
    text-transform: uppercase; 
    color: #fff; 
    letter-spacing: 1px;
}

.price-container { 
    margin: 10px 0; 
}

.card-price { 
    font-size: 1.6rem; 
    color: var(--accent); 
    font-weight: 800; 
    text-shadow: 0 0 10px var(--accent-glow); 
}

.card-stock { 
    font-size: 0.8rem; 
    color: var(--text-gray); 
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 15px;
}

/* BOTÓN PREMIUM */
.btn-buy {
    width: 100%; 
    padding: 14px; 
    border: 1px solid var(--accent); 
    background: rgba(124, 58, 237, 0.05); 
    color: var(--accent); 
    font-weight: 800; 
    cursor: pointer; 
    text-transform: uppercase; 
    font-size: 0.85rem; 
    transition: 0.3s;
    letter-spacing: 2px;
}

.btn-buy:hover { 
    background: var(--accent); 
    color: white; 
    box-shadow: 0 0 20px var(--accent-glow); 
}

/* ESTADO AGOTADO */
.product-card.sold-out {
    filter: grayscale(0.8);
    opacity: 0.7;
}

.product-card.sold-out .card-price {
    color: #444;
    text-shadow: none;
}

.btn-buy.disabled {
    border-color: #333;
    color: #555;
    background: #111;
    cursor: not-allowed;
}

/* ETIQUETA AGOTADO SOBRE IMAGEN */
.sold-out-badge {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-15deg);
    background: var(--danger);
    color: white;
    padding: 8px 20px;
    font-weight: 900;
    font-size: 1rem;
    border: 2px solid white;
    z-index: 10;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
/* --- ESTILOS MEJORADOS PARA MOVIMIENTOS DE BILLETERA --- */
.wallet-row-premium {
    border-bottom: 1px solid #111;
    transition: background 0.3s;
}

.wallet-row-premium:hover {
    background: rgba(124, 58, 237, 0.05); /* Efecto hover violeta muy sutil */
}

/* Ajuste a la tabla de historial para que se vea más limpia */
#wallet-history tr td {
    vertical-align: middle;
}

/* Efecto de parpadeo suave al saldo cuando se actualiza */
.wallet-amount {
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.wallet-amount:active {
    transform: scale(1.1);
}
/* --- SECCIÓN PEDIDOS ULTRA PREMIUM --- */
.orders-premium-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
    padding: 10px;
}

.order-premium-card {
    background: linear-gradient(145deg, #0f0f0f 0%, #050505 100%);
    border: 1px solid #1f1f1f;
    border-radius: 16px;
    padding: 20px;
    position: relative;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    overflow: hidden;
}

.order-premium-card:hover {
    transform: translateY(-8px);
    border-color: var(--accent);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7), 0 0 20px rgba(124, 58, 237, 0.15);
}

/* Cabecera de la tarjeta */
.card-order-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.service-name {
    font-family: 'Righteous', cursive;
    font-size: 1.3rem;
    color: #fff;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 4px;
}

.pulse-dot {
    width: 7px;
    height: 7px;
    background: #00e676;
    border-radius: 50%;
    box-shadow: 0 0 8px #00e676;
    animation: pulseStatus 2s infinite;
}

@keyframes pulseStatus {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(1.2); }
    100% { opacity: 1; transform: scale(1); }
}

.status-text {
    font-size: 0.65rem;
    font-weight: 800;
    color: #00e676;
    letter-spacing: 1px;
}

.header-right {
    text-align: right;
    display: flex;
    flex-direction: column;
}

.order-date { color: #fff; font-size: 0.8rem; font-weight: 600; }
.order-time { color: #444; font-size: 0.7rem; font-family: monospace; }

/* Cuerpo: Bóveda de credenciales */
.credential-box {
    background: #000;
    border: 1px solid #161616;
    border-radius: 12px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.credential-box .field { flex: 1; }
.credential-box label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.6rem;
    color: #444;
    font-weight: 800;
    margin-bottom: 6px;
    letter-spacing: 1px;
}

.credential-box .value {
    color: var(--accent);
    font-family: 'Inter', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    word-break: break-all;
}

.divider-v {
    width: 1px;
    height: 30px;
    background: #161616;
    margin: 0 15px;
}

/* Footer de la tarjeta */
.card-order-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #111;
    padding-top: 15px;
}

.warranty-tag {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.65rem;
    font-weight: 700;
    color: #222; /* Texto oscuro sutil */
    text-transform: uppercase;
}

.btn-copy-premium {
    background: var(--accent);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 800;
    transition: 0.3s;
}

.btn-copy-premium:hover {
    background: #6d28d9;
    box-shadow: 0 0 15px var(--accent-glow);
    transform: scale(1.05);
}

/* Estado sin pedidos */
.no-orders-container {
    grid-column: 1/-1;
    text-align: center;
    padding: 100px 20px;
    border: 1px dashed #1a1a1a;
    border-radius: 20px;
}
.no-orders-container span { font-size: 4rem; color: #111; margin-bottom: 20px; }
.no-orders-container p { color: #555; font-weight: 800; letter-spacing: 3px; }
.no-orders-container small { color: #222; }

/* --- LOGO COOL (Righteous) --- */
.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    overflow: hidden;
    padding: 5px 0;
    user-select: none;
}

.logo-img {
    height: 42px;
    width: auto;
    object-fit: contain;
    border-radius: 8px;
    filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.6)); /* Glow violeta detrás de la imagen */
    transition: transform 0.3s ease;
}

.logo:hover .logo-img { transform: scale(1.1) rotate(-3deg); }

.logo h2 {
    font-family: 'Righteous', cursive;
    font-size: 1.4rem;
    font-weight: 400;
    margin: 0;
    line-height: 1;
    letter-spacing: 1px;
    text-transform: uppercase;
    /* Efecto Degradado en Texto (Blanco a Azul Claro) */
    background: linear-gradient(to bottom, #ffffff 0%, #a5b4fc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
}
/* --- RESPONSIVE SIDEBAR & HAMBURGER --- */

/* Botón Hamburguesa */
.hamburger-menu {
    display: none; /* Oculto en PC */
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 1000;
    background: rgba(20, 20, 20, 0.8);
    border: 1px solid #333;
    color: #eee; /* Color Gris/Blanco */
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    backdrop-filter: blur(5px);
}

@media (max-width: 768px) {
    .hamburger-menu { display: block; } /* Mostrar en móviles */

    .sidebar {
        position: fixed;
        left: -280px; /* Escondido por defecto */
        top: 0;
        bottom: 0;
        z-index: 999;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 20px 0 50px rgba(0,0,0,0.8);
    }

    .sidebar.open {
        left: 0; /* Deslizar hacia adentro */
    }

    .main-content {
        margin-left: 0 !important;
        padding-top: 70px; /* Espacio para la hamburguesa */
    }
}
/* 1. FIX: FUERZA A QUE EL CARRITO DESAPAREZCA CUANDO JS LO ORDENA */
.hidden {
    display: none !important;
}

/* 2. FIX: MEJORA ESTÉTICA DEL USUARIO (Tarjeta flotante elegante, separada de las esquinas) */
.user-sidebar-info {
    margin: 15px 15px 25px 15px; /* Separación de las esquinas */
    padding: 15px;
    background: rgba(255, 255, 255, 0.03); /* Efecto cristal */
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 16px; /* Bordes suaves */
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.user-sidebar-info .user-name { font-size: 0.85rem; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; display: block; }
.user-sidebar-info .user-balance { color: var(--accent); font-weight: 800; font-family: 'Inter', monospace; font-size: 1.1rem; margin-top: 3px; }

/* Ajuste del botón salir para que no empuje el usuario contra el piso */
.nav-links {
    margin-bottom: 10px;
}
/* --- BOTÓN HAMBURGUESA OCULTO EN PC --- */
.hamburger-menu { display: none; }

/* --- RESPONSIVE UNIFICADO --- */
@media(max-width: 768px) {
  
  /* Botón Hamburguesa Config */
  .hamburger-menu { 
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 10000;
      background: #0a0a0a;
      border: 1px solid #222;
      color: #fff;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      backdrop-filter: blur(5px);
  }

  /* Sidebar Tipo Cajón Móvil */
  .sidebar { 
      position: fixed;
      left: -320px; /* Escondido a la izquierda */
      top: 0;
      bottom: 0;
      width: 280px;  /* Ancho obligatorio para ver opciones */
      background: #050505; /* Fondo oscuro sólido */
      z-index: 9999; 
      display: flex;
      flex-direction: column;
      padding-top: 70px; 
      transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 20px 0 50px rgba(0,0,0,0.9);
      border-right: 1px solid #1a1a1a;
  }
  .sidebar.open { left: 0; } /* Clase que añade el JS para mostrarlo */

  /* Ajustes de Contenido Móvil */
  .main-content { 
      margin-left: 0 !important; 
      padding: 80px 20px 20px 20px; /* Espacio superior para que la hamburguesa no tape el título */
  }
  
  .cart-drawer { width: 85%; }
  .hero-content h1 { font-size: 1.8rem; }
  .features-grid { flex-direction: column; align-items: center; }
  .orders-premium-grid { grid-template-columns: 1fr; }
}
/* =========================================================
   ESTILOS PREMIUM PARA ENLACES DE NAVEGACIÓN (LOGIN)
   ========================================================= */

/* Enlace "¿Olvidaste tu contraseña?" en el Login Principal */
.forgot-password-link {
    display: inline-block;
    color: #666; /* Color discreto por defecto */
    font-size: 0.75rem;
    text-align: center;
    margin-top: 20px;
    cursor: pointer;
    letter-spacing: 1.5px;
    font-weight: 600;
    text-transform: uppercase;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    padding-bottom: 2px;
}

/* Efecto de línea animada debajo */
.forgot-password-link::after {
    content: '';
    position: absolute;
    width: 0;
    height: 1px;
    bottom: 0;
    left: 50%;
    background: var(--accent);
    transition: all 0.3s ease;
    transform: translateX(-50%);
    box-shadow: 0 0 8px var(--accent);
}

.forgot-password-link:hover {
    color: var(--accent);
    transform: translateY(-1px);
}

.forgot-password-link:hover::after {
    width: 60%; /* La línea crece al pasar el mouse */
}

/* Enlace "Volver al inicio de sesión" en las pantallas de recuperación */
.back-to-login {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 25px;
    color: #555;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255,255,255,0.03);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid transparent;
}

.back-to-login:hover {
    color: #fff;
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.1);
}

/* Ajuste adicional para los botones de las cajas de recuperación */
#recover-step-1 .btn-login,
#recover-step-2 .btn-login {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 2px;
}
/* =========================================================
   BLOQUE DE MARCA PREMIUM - JEICO STREAMING
   ========================================================= */

.login-brand {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 40px;
    perspective: 1000px;
}

/* Contenedor del Logo con Efecto de Aura */
.logo-glow-container {
    position: relative;
    width: 120px;
    height: 120px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 10px;
}

.brand-logo-img {
    width: 100%;
    z-index: 2;
    filter: drop-shadow(0 0 10px rgba(124, 58, 237, 0.5));
    animation: floating 4s ease-in-out infinite;
}

/* Pulso de luz detrás del logo */
.logo-pulse {
    position: absolute;
    width: 80px;
    height: 80px;
    background: var(--accent);
    border-radius: 50%;
    filter: blur(40px);
    opacity: 0.6;
    z-index: 1;
    animation: glowPulse 3s infinite alternate;
}

/* Texto de Marca Estilo Futurista */
.brand-text-wrapper {
    text-align: center;
}

.brand-name {
    font-family: 'Righteous', cursive;
    font-size: 2.8rem;
    line-height: 1;
    color: #fff;
    letter-spacing: 5px;
    margin: 0;
    /* Texto con brillo suave */
    text-shadow: 2px 2px 0px #333, 0 0 20px rgba(255,255,255,0.2);
}

.brand-subtitle {
    font-size: 0.85rem;
    font-weight: 800;
    letter-spacing: 8px;
    margin-top: -5px;
    /* Gradiente animado en el texto */
    background: linear-gradient(90deg, #fff, var(--accent), #fff);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shineText 3s linear infinite;
    text-transform: uppercase;
}

/* ANIMACIONES "COOL" */

/* Flotación suave del logo */
@keyframes floating {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(5deg); }
}

/* Pulso de neón */
@keyframes glowPulse {
    from { transform: scale(1); opacity: 0.4; }
    to { transform: scale(1.4); opacity: 0.7; }
}

/* Movimiento del gradiente en el subtítulo */
@keyframes shineText {
    to { background-position: 200% center; }
}

/* Efecto responsive */
@media (max-width: 480px) {
    .brand-name { font-size: 2.2rem; }
    .brand-subtitle { font-size: 0.7rem; letter-spacing: 5px; }
    .logo-glow-container { width: 100px; height: 100px; }
}
/* =========================================================
   INPUTS Y BOTONES MODERNOS (ROUNDED STYLE)
   ========================================================= */

/* Estilo para todas las casillas de texto */
.input-field {
    width: 100%;
    background: rgba(255, 255, 255, 0.03) !important; /* Fondo casi invisible */
    border: 1px solid rgba(255, 255, 255, 0.1) !important; /* Borde sutil */
    color: #fff !important;
    padding: 16px 20px !important;
    border-radius: 16px !important; /* Bordes bien redondeados */
    font-size: 0.95rem !important;
    outline: none !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    margin-bottom: 15px;
}

/* Efecto cuando el usuario hace clic (Focus) */
.input-field:focus {
    background: rgba(124, 58, 237, 0.07) !important; /* Fondo morado muy suave */
    border-color: var(--accent) !important; /* Borde morado */
    box-shadow: 0 0 20px rgba(124, 58, 237, 0.2) !important; /* Brillo de neón */
    transform: translateY(-1px); /* Micro-movimiento hacia arriba */
}

/* Estilo para el Botón de Acceso */
.btn-login {
    width: 100%;
    background: linear-gradient(135deg, var(--accent), #6366f1) !important;
    color: white !important;
    border: none !important;
    padding: 16px !important;
    border-radius: 16px !important; /* Mismo redondeado que los inputs */
    font-weight: 800 !important;
    text-transform: uppercase;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s ease !important;
    box-shadow: 0 10px 20px -5px rgba(124, 58, 237, 0.4);
    margin-top: 10px;
}

.btn-login:hover {
    transform: scale(1.02); /* Crece un poquito */
    box-shadow: 0 15px 30px -5px rgba(124, 58, 237, 0.6);
    filter: brightness(1.1);
}

.btn-login:active {
    transform: scale(0.98); /* Efecto de pulsado */
}

/* Contenedor de la caja de login para que se vea como un cristal */
.login-box {
    background: rgba(10, 10, 10, 0.8) !important;
    backdrop-filter: blur(20px); /* Efecto esmerilado */
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    border-radius: 28px !important; /* Bordes extra redondeados para la caja */
    padding: 50px 40px !important;
}
/* Contenedor relativo para posicionar el ojo */
.input-group {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
}

/* El icono del ojo */
.eye-icon {
    position: absolute;
    right: 18px; /* Ajustado al redondeado de la casilla */
    color: var(--text-gray);
    cursor: pointer;
    font-size: 1.3rem;
    transition: all 0.3s ease;
    user-select: none;
    z-index: 10;
}

.eye-icon:hover {
    color: var(--accent);
    text-shadow: 0 0 10px var(--accent-glow);
}

/* Ajuste para que el texto no se meta debajo del ojo */
.input-field#pass {
    padding-right: 50px !important;
}
.login-banner-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 60vh;
    background-image: url('https://drive.google.com/thumbnail?id=1Yj6I6w5qDjBR20krMqzw9FL4nFwWTJxN&sz=w1920');
    background-size: cover;
    background-position: center top;
    z-index: 0;
    mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
}
/* =========================================================
   MEJORAS VISUALES DE ACCESO Y NAVEGACIÓN
   ========================================================= */

/* Título: Acceso a la Bóveda */
.vault-header {
    color: #fff;
    font-family: 'Righteous', cursive;
    font-size: 1.1rem;
    letter-spacing: 5px;
    margin-bottom: 35px;
    text-transform: uppercase;
    text-align: center;
    /* Efecto de resplandor morado */
    text-shadow: 0 0 15px rgba(124, 58, 237, 0.6);
    background: linear-gradient(to right, #fff, var(--accent), #fff);
    -webkit-background-clip: text;
    background-size: 200% auto;
    animation: shineText 5s linear infinite;
}

/* Títulos de secciones de recuperación */
.verify-header { color: #3b82f6; font-family: 'Righteous'; font-size: 1.1rem; letter-spacing: 3px; margin-bottom: 5px; }
.success-header { color: #10b981; font-family: 'Righteous'; font-size: 1.1rem; letter-spacing: 3px; margin-bottom: 5px; }

/* Texto Recordatorio */
.reminder-text {
    color: var(--text-gray);
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 25px;
    text-align: center;
    line-height: 1.4;
}

/* Cuadro Volver Mejorado */
.back-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 25px;
    padding: 12px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    color: #555;
    cursor: pointer;
    transition: all 0.3s ease;
}

.back-container span {
    font-size: 0.75rem;
    font-weight: 800;
    letter-spacing: 2px;
}

.back-container:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.15);
    color: #fff;
    transform: translateX(-5px); /* Efecto de retroceso */
}

/* Animación de brillo para el título */
@keyframes shineText {
    to { background-position: 200% center; }
}
.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 30px 20px;
    flex-shrink: 0; /* <--- ESTO EVITA QUE SE ACHIQUE */
    user-select: none;
}
</style>
</head>
<body>

  <div id="login-view">
    
    <div class="login-banner-bg"></div>
    
    <div class="login-box" id="login-box-main">
      <h2 class="vault-header">ACCESO A LA BÓVEDA</h2>
      
      <form id="login-form">
        <div class="input-group">
          <input type="text" id="user" class="input-field" placeholder="USUARIO" required>
        </div>
        
        <div class="input-group">
          <input type="password" id="pass" class="input-field" placeholder="CONTRASEÑA" required>
          <span class="material-icons-round eye-icon" id="togglePassword">visibility_off</span>
        </div>
        
        <button type="submit" class="btn-login">ENTRAR</button>
      </form>
      
      <p class="forgot-password-link" onclick="mostrarRecuperacionPaso1()">¿Olvidaste tu contraseña?</p>
    </div>

    <div class="login-box hidden" id="recover-step-1">
      <h2 class="verify-header">VERIFICAR IDENTIDAD</h2>
      <p class="reminder-text">Recuerda colocar tu correo y número registrados.</p>
      
      <form id="recover-form-1" onsubmit="enviarSolicitudRecuperacion(event)">
        <div class="input-group">
          <input type="email" id="rec-correo" class="input-field" placeholder="CORREO ELECTRÓNICO" required>
        </div>
        <div class="input-group">
          <input type="tel" id="rec-tel" class="input-field" placeholder="TELÉFONO REGISTRADO" required>
        </div>
        <button type="submit" class="btn-login" id="btn-recover-1" style="background: #3b82f6 !important;">COMPROBAR</button>
        
        <div class="back-container" onclick="volverLogin()">
            <span class="material-icons-round">keyboard_backspace</span>
            <span>VOLVER AL INICIO</span>
        </div>
      </form>
    </div>

    <div class="login-box hidden" id="recover-step-2">
      <h2 class="success-header">NUEVA CONTRASEÑA</h2>
      <p style="color: var(--text-gray); margin-bottom: 25px; font-size: 0.75rem; text-align: center;">Identidad confirmada. Define tu nueva clave de acceso.</p>
      
      <form id="recover-form-2" onsubmit="procesarNuevaClave(event)">
        <div class="input-group">
          <input type="password" id="rec-nueva-clave" class="input-field" placeholder="ASIGNAR NUEVA CLAVE" required>
        </div>
        <button type="submit" class="btn-login" id="btn-recover-2" style="background: #10b981 !important; color: #000 !important;">ACTUALIZAR</button>
      </form>
    </div>

  </div>

  <div id="app-view" style="display: none;">
    
    <aside class="sidebar">
      <div class="logo">
        <img src="https://drive.google.com/thumbnail?id=1VfnMFu-s6m4SQKgktjWxKuy6Nq0hGhI4&sz=w200" 
             alt="Logo Jeico" 
             class="logo-img">
        <h2>Jeico streaming</h2>
      </div>
      
      <ul class="nav-links">
        <li class="nav-item active" onclick="nav('inicio', this)">
          <span class="material-icons-round">home</span>
          <span>INICIO</span>
        </li>

        <li class="nav-item" onclick="nav('tienda', this)">
          <span class="material-icons-round">storefront</span>
          <span>TIENDA</span>
        </li>

        <li class="nav-item has-submenu" onclick="toggleSubmenu(this)">
          <div style="display:flex; align-items:center; gap:12px; width:100%;">
            <span class="material-icons-round">person</span>
            <span>MI CUENTA</span>
            <span class="material-icons-round arrow-icon" style="margin-left:auto; font-size:1.2rem;">expand_more</span>
          </div>
        </li>
        <ul class="submenu hidden" id="submenu-cuenta">
            <li class="submenu-item" onclick="nav('pedidos', this)">
                <span class="material-icons-round">receipt_long</span>
                <span>Mis Pedidos</span>
            </li>
            <li class="submenu-item" onclick="nav('billetera', this)">
                <span class="material-icons-round">account_balance_wallet</span>
                <span>Mi Billetera</span>
            </li>
            <li class="submenu-item" onclick="nav('datos', this)">
                <span class="material-icons-round">manage_accounts</span>
                <span>Mis Datos</span>
            </li>
        </ul>

        <li class="nav-item" onclick="nav('recarga', this)">
          <span class="material-icons-round">savings</span>
          <span>RECARGAR</span>
        </li>
        
        <li class="nav-item has-submenu" onclick="toggleSubmenu(this)">
          <div style="display:flex; align-items:center; gap:12px; width:100%;">
            <span class="material-icons-round">support_agent</span>
            <span>SOPORTE</span>
            <span class="material-icons-round arrow-icon" style="margin-left:auto; font-size:1.2rem;">expand_more</span>
          </div>
        </li>
        <ul class="submenu hidden" id="submenu-soporte">
            <li class="submenu-item" onclick="nav('soporte', this)">
                <span class="material-icons-round">bug_report</span>
                <span>Crear Ticket</span>
            </li>
            <li class="submenu-item" onclick="nav('mistickets', this)">
                <span class="material-icons-round">history_edu</span>
                <span>Mis Tickets</span>
            </li>
        </ul>
        
        <li class="nav-item" onclick="nav('codigos', this)">
            <span class="material-icons-round">vpn_key</span>
            <span>CÓDIGOS</span>
        </li>

        <li class="nav-item" onclick="nav('ranking', this)">
            <span class="material-icons-round">leaderboard</span>
            <span>RANKING</span>
        </li>
        
        <li class="nav-item logout-link" onclick="logout()" style="margin-top: auto;">
          <span class="material-icons-round">logout</span>
          <span>SALIR</span>
        </li>
      </ul>
      
      <div class="user-sidebar-info">
        <div class="user-avatar-circle">
          <span class="material-icons-round">account_circle</span>
        </div>
        <div class="user-data-text">
          <span class="user-name" id="display-user">...</span>
          <div class="user-balance" id="display-balance">$ 0</div>
        </div>
      </div>
    </aside>

    <button class="hamburger-menu" id="hamburger-btn" onclick="toggleSidebar()">
      <span class="material-icons-round">menu</span>
    </button>

    <main class="main-content" style="display: flex; flex-direction: column; min-height: 100vh;">
      
      <div id="sec-inicio">
        <div class="hero-container">
            <div class="hero-content">
                <h1>Entretenimiento Sin Límites</h1>
                <p>Acceso exclusivo a las mejores plataformas de streaming. Sistema automatizado, garantía inmediata y soporte profesional 24/7.</p>
                <button onclick="nav('tienda', document.querySelector('.nav-item[onclick*=\'tienda\']'))" class="cta-button">VER CUENTAS DISPONIBLES</button>
            </div>
        
            <div class="features-grid">
                <div class="feature-card">
                    <span class="feature-icon">⚡</span>
                    <span class="feature-title">ENTREGA INSTANTÁNEA</span>
                    <span class="feature-desc">Cuentas disponibles al momento de confirmar tu pedido.</span>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">🕒</span>
                    <span class="feature-title">SERVICIO 24 HORAS</span>
                    <span class="feature-desc">Nuestra plataforma opera sin interrupciones todo el año.</span>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">🛡️</span>
                    <span class="feature-title">GARANTÍA TOTAL</span>
                    <span class="feature-desc">Tu inversión está protegida por nuestro soporte técnico.</span>
                </div>
            </div>
        </div>
      </div>

      <div id="sec-tienda" class="hidden">
        <div class="section-header-premium">
          <h1 class="page-title">CATÁLOGO PREMIUM</h1>
          <p class="section-description">Selecciona el servicio que deseas activar en tu cuenta.</p>
        </div>
        <div id="shop-container" class="products-grid">
          <div class="spinner-container">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

      <div id="sec-billetera" class="hidden">
        <h1 class="page-title">MI BILLETERA</h1>
        <div class="wallet-layout">
          <div class="wallet-card">
              <div class="wallet-label">SALDO DISPONIBLE ACTUAL</div>
              <div class="wallet-amount" id="wallet-balance-big">$ 0.00</div>
              <div class="wallet-actions">
                  <button onclick="nav('recarga')" class="btn-wallet-action">
                      <span class="material-icons-round">add_circle</span>
                      <span>SOLICITAR RECARGA</span>
                  </button>
              </div>
          </div>
          <div class="history-container-premium">
              <div class="history-header">
                <h3>MOVIMIENTOS RECIENTES</h3>
                <span class="material-icons-round" style="color: var(--accent);">history</span>
              </div>
              <div class="table-responsive-wrapper">
                <table class="premium-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>DESCRIPCIÓN / TIPO</th>
                            <th style="text-align:center;">MONTO (COP)</th>
                            <th style="text-align:right;">NUEVO SALDO</th>
                        </tr>
                    </thead>
                    <tbody id="wallet-history">
                        <tr><td colspan="4" style="text-align:center; padding: 60px; color:#555;">Sincronizando movimientos...</td></tr>
                    </tbody>
                </table>
              </div>
          </div>
        </div>
      </div>

      <div id="sec-pedidos" class="hidden">
        <div class="page-header-premium">
            <h1 class="page-title">MIS ADQUISICIONES</h1>
            <p class="page-subtitle">Acceso directo a tus credenciales y bóveda personal.</p>
        </div>
        <div id="orders-container" class="orders-premium-grid">
            <div style="grid-column: 1/-1; text-align:center; padding:60px;">
                <div class="spinner"></div>
                <p style="color:var(--text-gray); margin-top:20px; letter-spacing:2px; font-size:0.8rem;">AUTENTICANDO ACCESO...</p>
            </div>
        </div>
      </div>

      <div id="sec-recarga" class="hidden">
        <div style="text-align:center; padding:100px;">
            <div class="spinner"></div>
            <p style="color:var(--text-gray); margin-top:20px; letter-spacing:2px;">PREPARANDO PASARELA...</p>
        </div>
      </div>

      <div id="sec-soporte" class="hidden">
        <h1 class="page-title">CENTRO DE AYUDA</h1>
        <div class="support-card-premium">
          <div class="support-header">
            <span class="material-icons-round" style="font-size: 3.5rem; color: var(--accent);">gpp_maybe</span>
            <h3>SOPORTE TÉCNICO</h3>
          </div>
          <p>¿Problemas con el acceso? Reporta fallos en cuentas, perfiles o renovaciones. Estamos para servirte.</p>
          <div class="support-info-grid">
            <div class="info-item">
              <strong>DISPONIBILIDAD</strong>
              <span>9:00 AM a 11:00 PM</span>
            </div>
            <div class="info-item">
              <strong>GARANTÍA</strong>
              <span>Protección total 30 días</span>
            </div>
          </div>
          <a href="https://wa.me/573016149753?text=Hola,%20tengo%20un%20problema%20con%20mi%20cuenta" target="_blank" class="cta-button" style="width: 100%; margin-top: 25px;">REPORTAR FALLA AHORA</a>
        </div>
      </div>

      <div id="sec-mistickets" class="hidden">
        <div class="page-header-premium">
            <h1 class="page-title">HISTORIAL DE SOPORTE</h1>
            <p class="page-subtitle">Seguimiento y estado de tus reportes de incidencias.</p>
        </div>
        <div id="tickets-container" class="orders-premium-grid">
            <div style="grid-column: 1/-1; text-align:center; padding:60px;">
                <div class="spinner"></div>
                <p style="color:var(--text-gray); margin-top:20px; letter-spacing:2px; font-size:0.8rem;">CARGANDO TICKETS...</p>
            </div>
        </div>
      </div>

      <div id="sec-codigos" class="hidden"></div>
      
      <div id="sec-ranking" class="hidden"></div>
      
      <div id="sec-datos" class="hidden"></div>

      <footer style="margin-top: auto; text-align: center; padding: 40px 20px 20px; border-top: 1px solid rgba(255,255,255,0.05);">
        <p style="color: #666; font-size: 0.85rem; margin: 0; letter-spacing: 0.5px;">
          &copy; 2026. Todos los derechos reservados.<br>
          <span style="display: inline-block; margin-top: 5px;">
            Desarrollado por <strong style="color: var(--accent, #7c3aed); font-weight: 700;">Brallan Ariza</strong>
          </span>
        </p>
      </footer>

    </main>

    <button class="floating-cart-btn hidden" id="main-cart-btn" onclick="toggleCart()">
      <span class="material-icons-round" style="font-size: 32px;">shopping_cart</span>
      <div class="cart-badge" id="cart-count">0</div>
    </button>

    <div class="overlay hidden" id="cart-overlay" onclick="toggleCart()"></div>
    
    <div class="cart-drawer" id="cart-drawer">
      <div class="drawer-header">
        <h2>MI CARRITO</h2>
        <button class="btn-close-drawer" onclick="toggleCart()">
            <span class="material-icons-round">close</span>
        </button>
      </div>
      <div class="drawer-body" id="cart-items-list">
        <p style="text-align:center; color:#444; margin-top:30px;">Tu carrito está esperando.</p>
      </div>
      <div class="drawer-footer">
        <div class="drawer-total">
            <span>TOTAL ESTIMADO:</span>
            <span id="cart-total-display">$ 0</span>
        </div>
        <button class="btn-checkout" onclick="goToCheckout()">PAGAR CON MI SALDO</button>
        <button class="btn-continue" onclick="toggleCart()">CONTINUAR COMPRANDO</button>
      </div>
    </div>

    <div class="overlay hidden" id="checkout-overlay"></div>
    <div class="checkout-modal" id="checkout-modal">
        <div class="checkout-header">CONFIRMACIÓN DE PAGO</div>
        <div class="checkout-body">
            <p style="color:#777; margin-bottom:20px; font-size: 0.85rem; text-align: center;">Estás a un paso de activar tus servicios. Revisa tu pedido:</p>
            <div id="checkout-summary-list" class="checkout-list-container"></div>
            <div class="checkout-total-row">
                <span>DÉBITO TOTAL:</span>
                <span id="checkout-final-total">$ 0</span>
            </div>
        </div>
        <div class="checkout-actions">
            <button class="btn-final-cancel" onclick="closeCheckout()">ATRÁS</button>
            <button class="btn-final-pay" onclick="finalizePurchase()">CONFIRMAR Y PAGAR</button>
        </div>
    </div>

  </div>

  
  
  
  
  
  
   
  
  
  
  


<script id="script-Tienda.js">/* Tienda.js */
/**
 * ===============================================================
 * TIENDA.JS - VERSIÓN DEFINITIVA (SINCRONIZACIÓN TOTAL POST-COMPRA)
 * ===============================================================
 */

const STORE_CACHE_KEY = "jeico_store_cache_v2";
const TIEMPO_VALIDEZ_CACHE = 5 * 60 * 1000; // 5 Minutos para todo el sistema

// --- CONFIGURACIÓN DE NOTIFICACIONES ---
const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 2500,
    background: '#0a0a0a',
    color: '#fff',
    iconColor: '#7c3aed',
    customClass: { container: 'swal-high-priority' }
});

/**
 * 1. CARGA INICIAL CON CACHÉ DE 5 MINUTOS
 */
async function cargarTienda(forzarRecarga = false) {
    const container = document.getElementById('shop-container');
    if (!container) return;

    const rawCache = localStorage.getItem(STORE_CACHE_KEY);
    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');

    // A. VALIDACIÓN DE CACHÉ
    if (rawCache && !forzarRecarga) {
        try {
            const cache = JSON.parse(rawCache);
            const edadCache = Date.now() - cache.timestamp;

            if (edadCache < TIEMPO_VALIDEZ_CACHE) {
                console.log("♻️ Tienda: Usando caché local (Menos de 5 min).");
                if (cache.saldo !== undefined) {
                    userBalance = Number(cache.saldo);
                    if (typeof updateBalanceUI === 'function') updateBalanceUI();
                }
                renderizarTiendaPremium(cache.productos, false);
                return; // CERO PETICIONES AL SERVER
            }
            // Si expiró pero existe, mostramos lo viejo mientras llega lo nuevo
            renderizarTiendaPremium(cache.productos, true);
        } catch (e) { localStorage.removeItem(STORE_CACHE_KEY); }
    }

    // B. SPINNER SI ESTÁ VACÍO
    if (!container.querySelector('.product-card')) {
        container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;"><div class="spinner"></div></div>';
    }

    // C. PETICIÓN AL SERVIDOR
    try {
        const res = await apiCall({ accion: 'getTienda', usuario: u, token: t });
        if (res.success) {
            userBalance = Number(res.saldo);
            if (typeof updateBalanceUI === 'function') updateBalanceUI();

            localStorage.setItem(STORE_CACHE_KEY, JSON.stringify({
                productos: res.productos,
                saldo: res.saldo,
                timestamp: Date.now()
            }));
            renderizarTiendaPremium(res.productos, false);
        } else if (res.msg === "Sesión inválida") {
            logout();
        }
    } catch (e) {
        console.error("Error tienda:", e);
    }
}

/**
 * 2. RENDERIZADOR DE TARJETAS
 */
function renderizarTiendaPremium(productos, isSyncing) {
    const container = document.getElementById('shop-container');
    container.innerHTML = "";

    if (!productos || productos.length === 0) {
        container.innerHTML = "<p style='grid-column: 1/-1; text-align:center; color:#444; padding:50px;'>Catálogo vacío actualmente.</p>";
        return;
    }

    productos.forEach(p => {
        let img = p.img;
        if (img && img.includes('drive')) {
            const id = img.match(/\/d\/([a-zA-Z0-9_-]+)/) || img.match(/id=([a-zA-Z0-9_-]+)/);
            if (id) img = `https://drive.google.com/thumbnail?id=${id[1]}&sz=w600`;
        }

        const stockActual = Number(p.stock) || 0;
        const isSoldOut = stockActual <= 0;
        const precioActual = Number(p.precio) || 0;
        const precioAnterior = Number(p.precioAnt) || 0;
        const tieneOferta = precioAnterior > precioActual;

        let btnHtml = isSyncing 
            ? `<button class="btn-buy" style="opacity:0.5; cursor:wait;">ACTUALIZANDO...</button>`
            : isSoldOut 
                ? `<button class="btn-buy disabled" disabled>AGOTADO</button>`
                : `<button class="btn-buy" onclick="addToCart('${p.nombre}', ${precioActual}, '${img}', ${stockActual})">AGREGAR AL CARRITO</button>`;

        const card = document.createElement('div');
        card.className = `product-card ${isSoldOut ? 'sold-out' : ''}`;
        
        card.innerHTML = `
            <div class="card-img-container">
                <img src="${img || ''}" class="card-img" alt="${p.nombre}">
                ${isSoldOut ? '<div class="sold-out-badge">AGOTADO</div>' : ''}
            </div>
            <div class="card-body">
                <div class="card-title">${p.nombre}</div>
                <div class="price-container">
                    ${tieneOferta ? `<div class="price-old-container"><span class="price-old">$ ${new Intl.NumberFormat('es-CO').format(precioAnterior)}</span><span class="offer-badge">OFERTA</span></div>` : ''}
                    <div class="card-price" ${tieneOferta ? 'style="color: #a855f7;"' : ''}>$ ${new Intl.NumberFormat('es-CO').format(precioActual)}</div>
                </div>
                <div class="card-stock">
                    ${isSoldOut ? '<span style="color:var(--danger); font-weight:800;">SIN STOCK DISPONIBLE</span>' : `Disponibles: <b>${stockActual}</b>`}
                </div>
                ${btnHtml}
            </div>
        `;
        container.appendChild(card);
    });
}

/**
 * 3. LÓGICA DEL CARRITO
 */
function addToCart(nombre, precio, img, stockReal) {
    const existe = cart.find(item => item.nombre === nombre);
    if (existe) {
        if (existe.cantidad < stockReal) {
            existe.cantidad++;
            Toast.fire({ icon: 'success', title: 'Cantidad aumentada' });
        } else {
            return Toast.fire({ icon: 'warning', title: 'Stock limitado', text: `Solo quedan ${stockReal} unidades.` });
        }
    } else {
        cart.push({ nombre, precio, img, cantidad: 1, stockMax: stockReal });
        Toast.fire({ icon: 'success', title: 'Producto añadido' });
    }
    updateCartUI();
}

function changeQty(index, delta) {
    const item = cart[index];
    const nuevaCant = item.cantidad + delta;
    if (nuevaCant > 0 && nuevaCant <= item.stockMax) {
        item.cantidad = nuevaCant;
    } else if (nuevaCant <= 0) {
        cart.splice(index, 1);
        Toast.fire({ icon: 'info', title: 'Producto eliminado' });
    }
    updateCartUI();
}

function updateCartUI() {
    const list = document.getElementById('cart-items-list');
    const badge = document.getElementById('cart-count');
    const totalDisplay = document.getElementById('cart-total-display');
    if (!list) return;
    list.innerHTML = "";
    let total = 0, count = 0;

    if(cart.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#555; margin-top:50px;">Carrito vacío</div>';
    } else {
        cart.forEach((item, index) => {
            total += item.precio * item.cantidad;
            count += item.cantidad;
            list.innerHTML += `
                <div class="cart-item-row-premium">
                    <img src="${item.img}" class="cart-item-img">
                    <div class="cart-item-info">
                        <h4 class="cart-item-title">${item.nombre}</h4>
                        <div class="cart-item-price">$ ${new Intl.NumberFormat('es-CO').format(item.precio)}</div>
                        <div class="qty-selector">
                            <button class="btn-qty" onclick="changeQty(${index}, -1)">-</button>
                            <span class="qty-num">${item.cantidad}</span>
                            <button class="btn-qty" onclick="changeQty(${index}, 1)">+</button>
                        </div>
                    </div>
                    <button class="btn-remove-item" onclick="removeFromCart(${index})"><span class="material-icons-round">close</span></button>
                </div>`;
        });
    }
    if (badge) badge.innerText = count;
    if (totalDisplay) totalDisplay.innerText = `$ ${new Intl.NumberFormat('es-CO').format(total)}`;
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartUI();
}

/**
 * 4. CHECKOUT Y PAGO FINAL (SINCRONIZACIÓN TOTAL)
 */
function goToCheckout() {
    if(cart.length === 0) return;
    let total = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    const summaryList = document.getElementById('checkout-summary-list');
    summaryList.innerHTML = "";
    cart.forEach(item => {
        summaryList.innerHTML += `
            <div class="checkout-item-premium">
                <div>
                    <div class="checkout-item-name">${item.nombre}</div>
                    <div class="checkout-item-qty">Unidades: ${item.cantidad}</div>
                </div>
                <div class="checkout-item-price">$ ${new Intl.NumberFormat('es-CO').format(item.precio * item.cantidad)}</div>
            </div>`;
    });
    document.getElementById('checkout-final-total').innerText = `$ ${new Intl.NumberFormat('es-CO').format(total)}`;
    toggleCart(); 
    document.getElementById('checkout-overlay').classList.remove('hidden');
    document.getElementById('checkout-modal').classList.add('active');
}

function closeCheckout() {
    document.getElementById('checkout-overlay').classList.add('hidden');
    document.getElementById('checkout-modal').classList.remove('active');
}

async function finalizePurchase() {
    let total = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    if(userBalance < total) return Toast.fire({ icon: 'error', title: 'Saldo insuficiente' });

    closeCheckout();
    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');
    
    Swal.fire({ 
        title: 'PROCESANDO PAGO', 
        text: 'Generando accesos...',
        didOpen: () => Swal.showLoading(), 
        background: '#0a0a0a', color: '#fff',
        allowOutsideClick: false,
        customClass: { container: 'swal-top-layer' }
    });

    let exitos = 0;
    for (const item of cart) {
        for(let i=0; i<item.cantidad; i++) {
            const res = await apiCall({ accion: 'comprar', usuario: u, token: t, producto: item.nombre });
            if(res.success) { 
                exitos++; 
                userBalance = res.nuevoSaldo; 
            }
        }
    }

    if(exitos > 0) {
        cart = []; 
        updateCartUI();
        updateBalanceUI();

        // --- MEJORA: RECARGA TRIPLE EN SEGUNDO PLANO ---
        // Al terminar, disparamos actualizaciones para todas las pestañas
        // para que al cambiar de sección todo esté listo al instante.
        console.log("🚀 Sincronizando Bóveda y Billetera tras compra...");
        
        const syncPromises = [
            apiCall({ accion: 'getTienda', usuario: u, token: t }),
            apiCall({ accion: 'getPedidos', usuario: u, token: t }),
            apiCall({ accion: 'getMovimientos', usuario: u, token: t })
        ];

        const [rTienda, rPedidos, rBilletera] = await Promise.all(syncPromises);

        // Actualizamos LocalStorage de Tienda
        if(rTienda.success) {
            localStorage.setItem(STORE_CACHE_KEY, JSON.stringify({
                productos: rTienda.productos,
                saldo: rTienda.saldo,
                timestamp: Date.now()
            }));
            renderizarTiendaPremium(rTienda.productos, false);
        }

        // Actualizamos LocalStorage de Pedidos (Bóveda)
        if(rPedidos.success) {
            localStorage.setItem("jeico_orders_cache_v2", JSON.stringify({
                datos: rPedidos.datos,
                timestamp: Date.now()
            }));
        }

        // Actualizamos LocalStorage de Billetera
        if(rBilletera.success) {
            localStorage.setItem("jeico_wallet_cache_v2", JSON.stringify({
                datos: rBilletera.datos,
                saldoActual: rBilletera.saldoActual,
                timestamp: Date.now()
            }));
        }

        Toast.fire({
            icon: 'success', title: '¡PAGO REALIZADO!',
            text: `Se activaron ${exitos} servicios. Revisa tu Bóveda.`,
            timer: 5000
        });
    } else {
        Toast.fire({ icon: 'error', title: 'Error en la compra' });
    }
}

/**
 * 5. ESTILOS INTEGRADOS
 */
const tiendaStyles = `
    .product-card { height: 480px; display: flex; flex-direction: column; overflow: hidden; margin-bottom: 20px;}
    .card-img-container { height: 50%; width: 100%; position: relative; background: #111; overflow: hidden; }
    .card-img { width: 100%; height: 100%; object-fit: cover; border-radius: 0; transition: transform 0.5s; }
    .product-card:hover .card-img { transform: scale(1.05); }
    .card-body { height: 50%; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(180deg, #0a0a0a 0%, #000000 100%); }
    .price-old-container { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: -5px; }
    .price-old { text-decoration: line-through; color: #555; font-size: 0.8rem; }
    .offer-badge { background: var(--accent); color: white; font-size: 0.6rem; font-weight: 900; padding: 2px 6px; border-radius: 2px; }
    .sold-out-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: var(--danger); color: white; padding: 8px 15px; font-weight: 900; border: 2px solid white; z-index: 10; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .product-card.sold-out { filter: grayscale(0.8); opacity: 0.7; }
    .btn-buy.disabled { border-color: #333; color: #555; background: #111; cursor: not-allowed; }
    .cart-item-row-premium { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid #111; }
    .cart-item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #222; }
    .cart-item-info { flex-grow: 1; }
    .cart-item-title { color: #fff; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
    .cart-item-price { color: var(--accent); font-weight: 700; font-size: 0.85rem; }
    .qty-selector { display: flex; align-items: center; gap: 10px; margin-top: 8px; background: #000; width: fit-content; padding: 2px 8px; border-radius: 4px; border: 1px solid #1a1a1a; }
    .btn-qty { background: none; border: none; color: var(--accent); font-size: 1.1rem; font-weight: 800; cursor: pointer; }
    .qty-num { color: #fff; font-size: 0.85rem; min-width: 15px; text-align: center; }
    .btn-remove-item { background: none; border: none; color: #444; cursor: pointer; transition: 0.3s; }
    .btn-remove-item:hover { color: var(--danger); }
    .checkout-item-premium { display: flex; justify-content: space-between; align-items: center; background: #050505; padding: 12px 15px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid var(--accent); }
    .checkout-item-name { color: #fff; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; }
    .checkout-item-qty { color: #555; font-size: 0.7rem; }
    .checkout-item-price { color: var(--accent); font-weight: 800; }
    .swal-high-priority { z-index: 99999 !important; }
    .swal2-container { z-index: 1000000 !important; }
    .swal-top-layer { z-index: 1000000 !important; }
    @media (max-width: 768px) { .sidebar .nav-links { display: block !important; } }
    .floating-cart-btn.hidden { display: none !important; }
    .cart-drawer:not(.open) { right: -150% !important; display: none !important; }
`;

const styleSheetTienda = document.createElement("style");
styleSheetTienda.innerText = tiendaStyles;
document.head.appendChild(styleSheetTienda);</script>
<script id="script-pedidos.js">/* pedidos.js */
/**
 * ===============================================================
 * PEDIDO.JS - VERSIÓN ULTRA PREMIUM (OPTIMIZADO 30 MIN CACHE)
 * ===============================================================
 */

// --- CONFIGURACIÓN DE CACHÉ ---
const ORDERS_CACHE_KEY = "jeico_orders_cache_v2";
const STORE_CACHE_KEY_REF = "jeico_store_cache"; 
const TIEMPO_VALIDEZ_PEDIDOS = 30 * 60 * 1000; // 30 Minutos

let cargandoPedidos = false;

/**
 * 1. FUNCIÓN PRINCIPAL DE CARGA
 */
async function cargarPedidos(forzarRecarga = false) {
    if (cargandoPedidos) return;
    cargandoPedidos = true;

    const container = document.getElementById('orders-container');
    if (!container) {
        cargandoPedidos = false;
        return;
    }
    
    // A. VALIDACIÓN DE CACHÉ INTELIGENTE
    const cachedDataRaw = localStorage.getItem(ORDERS_CACHE_KEY);
    
    if (cachedDataRaw && !forzarRecarga) {
        try {
            const cache = JSON.parse(cachedDataRaw);
            const edadCache = Date.now() - cache.timestamp;

            // SI EL CACHÉ ES JOVEN (Menos de 30 min), NO HAY PETICIÓN
            if (edadCache < TIEMPO_VALIDEZ_PEDIDOS) {
                console.log(`♻️ Pedidos desde caché (Edad: ${Math.round(edadCache/60000)} min).`);
                renderizarPedidosPremium(cache.datos);
                cargandoPedidos = false;
                return; // <--- ESCUDO: DETIENE LA SOLICITUD AL SERVER
            }
        } catch (e) {
            console.warn("Error en caché de pedidos, sincronizando de nuevo...");
        }
    }

    // B. SI NO HAY CACHÉ O EXPIRÓ: MOSTRAR CARGA (Solo si el contenedor está vacío)
    if (!container.querySelector('.order-premium-card')) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align:center; padding:80px;">
                <div class="spinner"></div>
                <p style="color:var(--text-gray); margin-top:20px; letter-spacing:3px; font-size:0.8rem; text-transform:uppercase; font-weight:800;">
                    Sincronizando Bóveda...
                </p>
            </div>`;
    }

    // C. CONSULTAR SERVIDOR (SINCRONIZACIÓN)
    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');

    try {
        const res = await apiCall({ accion: 'getPedidos', usuario: u, token: t });

        if (res.success && res.datos) {
            // Guardamos en caché con Timestamp actual
            localStorage.setItem(ORDERS_CACHE_KEY, JSON.stringify({
                datos: res.datos,
                timestamp: Date.now()
            }));
            
            renderizarPedidosPremium(res.datos);
        } else if (res.msg === "Sesión inválida") {
            logout();
        }
    } catch (error) {
        console.error("Error crítico al sincronizar pedidos:", error);
        if (!cachedDataRaw) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#ff0055;">Falla de conexión</div>`;
        }
    } finally {
        cargandoPedidos = false;
    }
}

/**
 * 2. RENDERIZADOR DE TARJETAS (REDISEÑADO CON IMAGEN)
 */
function renderizarPedidosPremium(pedidos) {
    const container = document.getElementById('orders-container');
    if (!container) return;
    
    container.innerHTML = "";

    if (!pedidos || pedidos.length === 0) {
        container.innerHTML = `
            <div class="no-orders-container">
                <span class="material-icons-round" style="font-size:4rem; color:#111; margin-bottom:20px;">history_toggle_off</span>
                <p style="color:#555; text-transform:uppercase; letter-spacing:3px; font-weight:800;">Bóveda Vacía</p>
            </div>`;
        return;
    }

    // --- OBTENER IMÁGENES DEL CACHÉ DE LA TIENDA ---
    let storeProducts = [];
    try {
        const storeCache = localStorage.getItem(STORE_CACHE_KEY_REF);
        if (storeCache) storeProducts = JSON.parse(storeCache).productos || [];
    } catch (e) { }

    // Ordenar por fecha (más reciente primero)
    const pedidosOrdenados = [...pedidos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

    pedidosOrdenados.forEach(p => {
        // Formatear Fecha y Hora
        const fechaObj = p.fecha ? new Date(p.fecha) : null;
        const fechaVal = fechaObj && !isNaN(fechaObj) ? fechaObj.toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Reciente';
        const horaVal = fechaObj && !isNaN(fechaObj) ? fechaObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : '';

        // Buscar imagen del servicio
        const productMatch = storeProducts.find(prod => prod.nombre === p.servicio);
        let imgUrl = productMatch ? productMatch.img : null;
        
        if (imgUrl && imgUrl.includes('drive')) {
            const id = imgUrl.match(/\/d\/([a-zA-Z0-9_-]+)/) || imgUrl.match(/id=([a-zA-Z0-9_-]+)/);
            if (id) imgUrl = `https://drive.google.com/thumbnail?id=${id[1]}&sz=w200`;
        }

        const imgHtml = imgUrl 
            ? `<img src="${imgUrl}" alt="${p.servicio}" class="order-thumb-img">`
            : `<div class="order-thumb-fallback"><span class="material-icons-round">stars</span></div>`;

        const card = document.createElement('div');
        card.className = 'order-premium-card';
        
        card.innerHTML = `
            <div class="card-order-header">
                <div class="header-left-premium">
                    ${imgHtml} 
                    <div class="header-info-block">
                        <span class="service-name-premium">${p.servicio}</span>
                        <div class="status-indicator">
                            <span class="pulse-dot"></span>
                            <span class="status-text">SERVICIO ACTIVO</span>
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <span class="order-date">${fechaVal}</span>
                    <span class="order-time">${horaVal}</span>
                </div>
            </div>

            <div class="card-order-body-refined">
                <div class="credential-row">
                    <div class="cred-label-refined"><span class="material-icons-round">alternate_email</span> Usuario/Cuenta</div>
                    <div class="cred-value-refined select-all">${p.cuenta}</div>
                </div>
                <div class="credential-row">
                    <div class="cred-label-refined"><span class="material-icons-round">vpn_key</span> Contraseña</div>
                    <div class="cred-value-refined select-all">${p.clave}</div>
                </div>
            </div>

            <div class="card-order-footer">
                <div class="warranty-tag">
                    <span class="material-icons-round verified-icon">verified</span>
                    <span style="font-size: 0.65rem;">GARANTÍA OFICIAL</span>
                </div>
                <button class="btn-copy-premium-refined" 
                        onclick="copiarPedidoPremium('${p.servicio}', '${fechaVal} ${horaVal}', '${p.cuenta}', '${p.clave}')">
                    COPIAR DATOS
                    <span class="material-icons-round" style="font-size:1rem;">content_copy</span>
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
}

/**
 * 3. FUNCIÓN DE COPIADO PREMIUM
 */
function copiarPedidoPremium(servicio, fechaCompleta, cuenta, clave) {
    const textoParaCopiar = `🌟 JEICO STREAMING 🌟\n\nServicio: ${servicio}\n\n📧 ID: ${cuenta}\n🔑 Pass: ${clave}\n\n📅 Activado el: ${fechaCompleta}\n--------------------------\n¡Que lo disfrutes! 🍿`;

    navigator.clipboard.writeText(textoParaCopiar).then(() => {
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
            background: '#0a0a0a', color: '#fff', iconColor: '#7c3aed'
        });
        Toast.fire({ icon: 'success', title: '¡Credenciales copiadas!' });
    }).catch(err => {
        Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: 'Error al copiar', showConfirmButton: false, timer: 2000 });
    });
}

/**
 * 4. INYECCIÓN DE ESTILOS REFINADOS
 */
const pedidosRefinedStyles = `
    .orders-premium-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px; padding: 10px; }
    .order-premium-card { background: linear-gradient(160deg, #141414 0%, #080808 100%); border: 1px solid #1f1f1f; border-radius: 16px; padding: 22px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: all 0.3s ease; animation: cardSlideIn 0.4s ease forwards; opacity: 0; }
    .order-premium-card:hover { border-color: rgba(124, 58, 237, 0.5); transform: translateY(-5px); }
    .card-order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .header-left-premium { display: flex; align-items: center; gap: 12px; }
    .order-thumb-img { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; border: 1px solid #2a2a2a; }
    .order-thumb-fallback { width: 48px; height: 48px; border-radius: 10px; background: #1a1a1a; display: flex; align-items: center; justify-content: center; border: 1px solid #2a2a2a; color: var(--accent); }
    .header-info-block { display: flex; flex-direction: column; }
    .service-name-premium { font-family: 'Righteous', sans-serif; font-size: 1.1rem; color: #fff; line-height: 1.2; }
    .status-indicator { display: flex; align-items: center; gap: 6px; margin-top: 4px; }
    .pulse-dot { width: 6px; height: 6px; background: #00e676; border-radius: 50%; animation: pulseGreen 2s infinite; }
    .status-text { font-size: 0.6rem; font-weight: 800; color: #00e676; letter-spacing: 1px; }
    .header-right { text-align: right; }
    .order-date { color: #888; font-size: 0.75rem; display: block; }
    .order-time { color: #555; font-size: 0.7rem; font-family: monospace; }
    .card-order-body-refined { background: rgba(255, 255, 255, 0.02); border-radius: 12px; padding: 15px; border: 1px solid rgba(255, 255, 255, 0.05); }
    .credential-row { margin-bottom: 15px; }
    .cred-label-refined { display: flex; align-items: center; gap: 6px; font-size: 0.65rem; color: var(--accent); font-weight: 700; text-transform: uppercase; }
    .cred-value-refined { font-family: 'Inter', monospace; font-size: 0.95rem; color: #e0e0e0; background: rgba(0,0,0,0.2); padding: 8px 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #1a1a1a; }
    .select-all { user-select: all; }
    .card-order-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #1a1a1a; }
    .warranty-tag { display: flex; align-items: center; gap: 5px; color: #555; font-weight: 700; }
    .btn-copy-premium-refined { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px 16px; border-radius: 50px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.7rem; font-weight: 800; transition: 0.3s; }
    .btn-copy-premium-refined:hover { background: var(--accent); color: white; }
    @keyframes cardSlideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 230, 118, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); } }
    .no-orders-container { grid-column: 1/-1; text-align: center; padding: 80px 20px; border: 1px dashed #222; border-radius: 20px; }
`;

const styleSheetPedidos = document.createElement("style");
styleSheetPedidos.innerText = pedidosRefinedStyles;
document.head.appendChild(styleSheetPedidos);</script>
<script id="script-billetera.js">/* billetera.js */
/**
 * ===============================================================
 * BILLETERA.JS - GESTIÓN DE SALDO (OPTIMIZADO 30 MIN CACHE)
 * ===============================================================
 */

const WALLET_CACHE_KEY = "jeico_wallet_cache_v2";
const TIEMPO_VALIDEZ_WALLET = 30 * 60 * 1000; // 30 Minutos
let cargandoBilletera = false;

/**
 * 1. FUNCIÓN PRINCIPAL DE CARGA
 */
async function cargarBilletera(forzarRecarga = false) {
    if (cargandoBilletera) return;
    cargandoBilletera = true;

    const historyBody = document.getElementById('wallet-history');
    if (!historyBody) {
        cargandoBilletera = false;
        return;
    }

    // A. VALIDACIÓN DE CACHÉ INTELIGENTE
    const cachedDataRaw = localStorage.getItem(WALLET_CACHE_KEY);
    
    if (cachedDataRaw && !forzarRecarga) {
        try {
            const cache = JSON.parse(cachedDataRaw);
            const edadCache = Date.now() - cache.timestamp;

            // SI LA CACHÉ TIENE MENOS DE 30 MINUTOS, NO MOLESTAMOS AL SERVIDOR
            if (edadCache < TIEMPO_VALIDEZ_WALLET) {
                console.log(`♻️ Billetera desde caché (Edad: ${Math.round(edadCache/60000)} min).`);
                
                // Actualizar saldo global en la UI si existe la función
                if (cache.saldoActual !== undefined) {
                    userBalance = Number(cache.saldoActual);
                    if (typeof updateBalanceUI === 'function') updateBalanceUI();
                }

                renderMovimientos(cache.datos);
                cargandoBilletera = false;
                return; // PARAR AQUÍ: CERO SOLICITUDES
            }
        } catch (e) {
            console.warn("Error en caché de billetera, recargando...");
        }
    }

    // B. SI NO HAY CACHÉ O EXPIRÓ: MOSTRAR CARGA (Solo si la tabla está vacía)
    if (!historyBody.querySelector('.wallet-row-premium')) {
        historyBody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align:center; padding:60px;">
                    <div class="spinner"></div>
                    <p style="color:#444; margin-top:15px; letter-spacing:2px; font-size:0.75rem;">SINCRONIZANDO ESTADO DE CUENTA...</p>
                </td>
            </tr>`;
    }

    // C. CONSULTA AL SERVIDOR
    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');

    try {
        const res = await apiCall({ accion: 'getMovimientos', usuario: u, token: t });

        if (res.success) {
            // Actualizar Saldo Global
            userBalance = Number(res.saldoActual);
            if (typeof updateBalanceUI === 'function') updateBalanceUI();

            // Guardar en caché con Timestamp
            localStorage.setItem(WALLET_CACHE_KEY, JSON.stringify({
                datos: res.datos,
                saldoActual: res.saldoActual,
                timestamp: Date.now()
            }));

            renderMovimientos(res.datos);
        } else if (res.msg === "Sesión inválida") {
            logout();
        }
    } catch (e) {
        console.error("Error crítico en Billetera:", e);
        if (!cachedDataRaw) {
            historyBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--danger);">Error de conexión</td></tr>`;
        }
    } finally {
        cargandoBilletera = false;
    }
}

/**
 * 2. RENDERIZADOR DE MOVIMIENTOS (TODO CENTRADO)
 */
function renderMovimientos(movimientos) {
    const historyBody = document.getElementById('wallet-history');
    if (!historyBody) return;
    
    historyBody.innerHTML = "";

    if (!movimientos || movimientos.length === 0) {
        historyBody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align:center; padding:50px; color:#444; font-size:0.8rem; letter-spacing:1px;">
                    NO SE REGISTRAN MOVIMIENTOS EN ESTA CUENTA.
                </td>
            </tr>`;
        return;
    }

    movimientos.forEach(m => {
        const montoNum = Number(m.monto);
        const esGasto = montoNum < 0;
        const colorMonto = esGasto ? 'var(--danger)' : 'var(--success)';
        const signo = esGasto ? '' : '+';
        
        const fechaOriginal = m.fecha ? new Date(m.fecha) : null;
        const fechaFormateada = fechaOriginal && !isNaN(fechaOriginal) 
            ? fechaOriginal.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' })
            : '---';

        const row = document.createElement('tr');
        row.className = 'wallet-row-premium';
        
        row.innerHTML = `
            <td style="padding:18px 15px; text-align:center; color:#555; font-size:0.85rem; font-family:monospace;">
                ${fechaFormateada}
            </td>

            <td style="padding:18px 15px; text-align:center;">
                <div style="color:#eee; font-weight:600; font-size:0.85rem; text-transform:uppercase; letter-spacing:0.5px;">
                    ${m.motivo}
                </div>
            </td>

            <td style="padding:18px 15px; text-align:center;">
                <span style="color:${colorMonto}; font-weight:800; font-size:0.95rem;">
                    ${signo}${new Intl.NumberFormat('es-CO').format(montoNum)}
                </span>
            </td>

            <td style="padding:18px 15px; text-align:center;">
                <span style="color:#aaa; font-weight:600; font-size:0.9rem; font-family:monospace;">
                    ${new Intl.NumberFormat('es-CO').format(m.saldoNuevo)}
                </span>
            </td>
        `;
        
        historyBody.appendChild(row);
    });
}

/**
 * 3. ESTILOS DINÁMICOS
 */
const walletExtraStyles = `
    .premium-table {
        width: 100%;
        border-collapse: collapse;
    }
    .premium-table thead th {
        background: #050505;
        color: #444;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        padding: 15px;
        border-bottom: 1px solid #1a1a1a;
        text-align: center;
    }
    .wallet-row-premium {
        border-bottom: 1px solid #0f0f0f;
        transition: all 0.3s ease;
    }
    .wallet-row-premium:hover {
        background: rgba(124, 58, 237, 0.03);
    }
    .table-responsive-wrapper {
        width: 100%;
        overflow-x: auto;
    }
`;

const styleSheetWallet = document.createElement("style");
styleSheetWallet.innerText = walletExtraStyles;
document.head.appendChild(styleSheetWallet);</script>
<script id="script-recarga.js">/* recarga.js */
/**
 * ===============================================================
 * RECARGA.JS - VERSIÓN ULTRA-PREMIUM (BLINDADA & CENTRADA)
 * ===============================================================
 */

// 1. Configuración de montos predeterminados
const RECHARGE_OPTIONS = [
    { monto: 10000, label: "Paquete Bronce", icon: "stars" },
    { monto: 20000, label: "Paquete Plata", icon: "auto_awesome" },
    { monto: 50000, label: "Paquete Oro", icon: "workspace_premium" },
    { monto: 100000, label: "Paquete Elite", icon: "diamond" }
];

let selectedAmount = null;

// ID de la imagen de WhatsApp en Drive para el thumbnail (Ajuste de visibilidad)
const WSP_ICON_ID = "12_hw1hRhhGNGv1UY7CX-YJajITFtrY-S";
const WSP_ICON_URL = `https://drive.google.com/thumbnail?id=${WSP_ICON_ID}&sz=w200`;

/**
 * 2. FUNCIÓN PRINCIPAL DE CARGA
 * Genera la estructura centrada y armónica.
 */
function cargarRecarga() {
    const container = document.getElementById('sec-recarga');
    
    container.innerHTML = `
        <div class="recharge-wrapper-premium">
            <div class="page-header-premium">
                <h1 class="page-title">CENTRO DE RECARGAS</h1>
                <p class="page-subtitle">Selecciona un paquete o ingresa el valor deseado para fondear tu cuenta.</p>
            </div>

            <div class="recharge-grid-premium" id="recharge-options-container">
                </div>

            <div class="recharge-input-section">
                <p class="input-helper-text">O INGRESA UN MONTO PERSONALIZADO</p>
                <div class="recharge-custom-input-container">
                    <input type="number" id="custom-recharge" placeholder="Ejem: 15000" class="input-field-recharge" inputmode="numeric">
                </div>
            </div>

            <div class="recharge-actions-elite">
                <button onclick="enviarAlWhatsApp()" class="btn-action-recharge wsp">
                    <img src="${WSP_ICON_URL}" alt="WSP" class="btn-icon-wsp">
                    RECARGAR VÍA WHATSAPP
                </button>
                
                <button onclick="mostrarMantenimiento()" class="btn-action-recharge bank">
                    <span class="material-icons-round">account_balance</span>
                    PAGO BANCOLOMBIA
                </button>
            </div>
        </div>
    `;

    renderizarOpcionesRecarga();
}

/**
 * 3. RENDERIZADOR DE TARJETAS
 */
function renderizarOpcionesRecarga() {
    const container = document.getElementById('recharge-options-container');
    if (!container) return;
    container.innerHTML = "";

    RECHARGE_OPTIONS.forEach(opt => {
        const card = document.createElement('div');
        card.className = `recharge-card-premium ${selectedAmount === opt.monto ? 'active' : ''}`;
        card.onclick = () => seleccionarMonto(opt.monto, card);

        card.innerHTML = `
            <div class="recharge-card-icon">
                <span class="material-icons-round">${opt.icon}</span>
            </div>
            <div class="recharge-card-info">
                <span class="recharge-label">${opt.label}</span>
                <span class="recharge-price">$ ${new Intl.NumberFormat('es-CO').format(opt.monto)}</span>
            </div>
            <div class="selection-check">
                <span class="material-icons-round">check_circle</span>
            </div>
        `;
        container.appendChild(card);
    });
}

/**
 * 4. LÓGICA DE SELECCIÓN
 */
function seleccionarMonto(monto, element) {
    selectedAmount = monto;
    
    // Limpiar input personalizado al elegir tarjeta
    const customInput = document.getElementById('custom-recharge');
    if (customInput) customInput.value = "";

    // Actualizar estados visuales
    document.querySelectorAll('.recharge-card-premium').forEach(c => c.classList.remove('active'));
    element.classList.add('active');

    const Toast = Swal.mixin({
        toast: true, position: 'top-end', showConfirmButton: false, timer: 1000,
        background: '#0a0a0a', color: '#fff', iconColor: '#7c3aed'
    });
    Toast.fire({ icon: 'info', title: 'Monto fijado' });
}

/**
 * 5. ENVÍO A WHATSAPP (SOLUCIÓN DEFINITIVA A CARACTERES EXTRAÑOS)
 */
function enviarAlWhatsApp() {
    const customValue = document.getElementById('custom-recharge').value;
    const finalAmount = customValue ? parseInt(customValue) : selectedAmount;

    if (!finalAmount || finalAmount <= 0) {
        return Swal.fire({
            title: 'Monto Requerido',
            text: 'Por favor, selecciona un paquete o escribe un valor válido.',
            icon: 'warning',
            background: '#0a0a0a',
            color: '#fff',
            confirmButtonColor: '#7c3aed'
        });
    }

    const u = localStorage.getItem('jeico_user') || 'Cliente';
    const montoFormateado = new Intl.NumberFormat('es-CO').format(finalAmount);
    
    // --- BYPASS DE ENCODING USANDO HEX PERCENT-ENCODING ---
    // Esto garantiza que los emojis se envíen bien sin importar el formato del archivo JS
    // Estrella = %F0%9F%8C%9F | Usuario = %F0%9F%91%A4 | Dinero = %F0%9F%92%B0 | Cohete = %F0%9F%9A%80
    
    const starHex = "%F0%9F%8C%9F";
    const userHex = "%F0%9F%91%A4";
    const moneyHex = "%F0%9F%92%B0";
    const rocketHex = "%F0%9F%9A%80";

    const titulo = encodeURIComponent("*SOLICITUD DE RECARGA JEICO*");
    const userLabel = encodeURIComponent("*Usuario:*");
    const amountLabel = encodeURIComponent("*Monto a recargar:*");
    const despedida = encodeURIComponent("Favor indicarme los medios de pago disponibles. Quedo atento al comprobante.");

    // Construcción de URL cruda para evitar que el navegador corrompa los emojis
    const url = `https://wa.me/573016149753?text=${starHex}%20${titulo}%20${starHex}%0A%0A${userHex}%20${userLabel}%20${encodeURIComponent(u)}%0A${moneyHex}%20${amountLabel}%20${encodeURIComponent(montoFormateado)}%0A%0A${despedida}%20${rocketHex}`;

    window.open(url, '_blank');
}

/**
 * 6. MANTENIMIENTO BANCOLOMBIA
 */
function mostrarMantenimiento() {
    Swal.fire({
        title: 'Metodo de pago en Mantenimiento',
        text: 'El sistema de pagos automáticos Bancolombia está siendo actualizado. Por ahora, usa WhatsApp.',
        icon: 'info',
        background: '#0a0a0a',
        color: '#fff',
        confirmButtonText: 'ENTENDIDO',
        confirmButtonColor: '#7c3aed'
    });
}

/**
 * 7. ESTILOS DE RECARGA (TODO CENTRADO Y SIN FLECHAS)
 */
const recargaStyles = `
    .recharge-wrapper-premium {
        max-width: 850px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 20px;
    }

    .recharge-grid-premium {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        width: 100%;
        margin-bottom: 40px;
        justify-content: center;
    }

    .recharge-card-premium {
        background: rgba(15, 15, 15, 0.8);
        border: 1px solid #1a1a1a;
        padding: 30px 20px;
        border-radius: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .recharge-card-premium:hover {
        background: rgba(25, 25, 25, 1);
        border-color: #333;
        transform: translateY(-5px);
    }

    .recharge-card-premium.active {
        border-color: var(--accent);
        background: rgba(124, 58, 237, 0.1);
        box-shadow: 0 0 30px rgba(124, 58, 237, 0.2);
    }

    .recharge-card-icon span {
        font-size: 2.8rem;
        color: #222;
        margin-bottom: 15px;
        display: block;
    }

    .recharge-card-premium.active .recharge-card-icon span {
        color: var(--accent);
        text-shadow: 0 0 15px var(--accent-glow);
    }

    .recharge-label {
        display: block;
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: #555;
        margin-bottom: 8px;
    }

    .recharge-price {
        display: block;
        font-size: 1.5rem;
        font-weight: 800;
        color: #fff;
        font-family: 'Inter', sans-serif;
    }

    .selection-check {
        position: absolute;
        top: 15px;
        right: 15px;
        color: var(--accent);
        opacity: 0;
        transition: 0.3s;
    }

    .recharge-card-premium.active .selection-check { opacity: 1; }

    .recharge-input-section {
        width: 100%;
        max-width: 400px;
        text-align: center;
        margin-bottom: 40px;
    }

    .input-helper-text {
        color: #444;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 15px;
        font-weight: 700;
    }

    /* ELIMINAR FLECHAS DE INCREMENTO (SPINNERS) */
    .input-field-recharge::-webkit-outer-spin-button,
    .input-field-recharge::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .input-field-recharge {
        -moz-appearance: textfield; /* Firefox */
        background: #000;
        border: 1px solid #1a1a1a;
        padding: 20px;
        border-radius: 15px;
        color: white;
        text-align: center;
        width: 100%;
        font-size: 1.3rem;
        font-weight: 600;
        transition: 0.3s;
    }

    .input-field-recharge:focus {
        border-color: var(--accent);
        outline: none;
        box-shadow: 0 0 20px rgba(124, 58, 237, 0.1);
    }

    .recharge-actions-elite {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .btn-action-recharge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        width: 100%;
        max-width: 400px;
        padding: 18px;
        border-radius: 50px;
        font-weight: 800;
        letter-spacing: 2px;
        cursor: pointer;
        transition: 0.3s;
        border: none;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    .btn-action-recharge.wsp {
        background: #25d366;
        color: #000;
    }

    .btn-action-recharge.wsp:hover {
        background: #20ba5a;
        box-shadow: 0 0 30px rgba(37, 211, 102, 0.2);
        transform: scale(1.02);
    }

    .btn-icon-wsp {
        width: 28px;
        height: 28px;
        object-fit: contain;
    }

    .btn-action-recharge.bank {
        background: transparent;
        border: 1px solid #1a1a1a;
        color: #444;
    }

    .btn-action-recharge.bank:hover {
        border-color: #333;
        color: #fff;
    }
`;

// Inyección de estilos
const styleSheetRecarga = document.createElement("style");
styleSheetRecarga.innerText = recargaStyles;
document.head.appendChild(styleSheetRecarga);</script>
<script id="script-datos.js">/* datos.js */
/**
 * ===============================================================
 * DATOS.JS - GESTIÓN DE PERFIL (CACHÉ INTELIGENTE 5M / 24H)
 * ===============================================================
 */

const TIEMPO_CACHE_INCOMPLETO = 5 * 60 * 1000; // 5 Minutos
const TIEMPO_CACHE_COMPLETO = 24 * 60 * 60 * 1000; // 24 Horas

async function cargarDatos() {
    const container = document.getElementById('sec-datos');
    if (!container) return;

    // 1. Renderizamos la estructura base
    container.innerHTML = `
        <div class="datos-wrapper-premium">
            <div class="page-header-premium" style="text-align: center; margin-bottom: 30px;">
                <h1 class="page-title">MI <span>PERFIL</span></h1>
                <p class="page-subtitle">Gestiona tu información personal y opciones de recuperación.</p>
            </div>

            <div class="card-datos">
                <div id="loading-datos" style="text-align:center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="color:#777; margin-top:15px; font-size:0.85rem; letter-spacing:2px;">CARGANDO DATOS...</p>
                </div>

                <form id="form-datos-perfil" class="hidden" onsubmit="actualizarMisDatos(event)">
                    
                    <div class="datos-grid">
                        <div class="input-group-premium">
                            <label>NOMBRE</label>
                            <div class="datos-input-wrapper">
                                <span class="material-icons-round datos-input-icon">badge</span>
                                <input type="text" id="perfil-nombre" class="datos-input" placeholder="Tu nombre">
                            </div>
                        </div>

                        <div class="input-group-premium">
                            <label>APELLIDO</label>
                            <div class="datos-input-wrapper">
                                <span class="material-icons-round datos-input-icon">badge</span>
                                <input type="text" id="perfil-apellido" class="datos-input" placeholder="Tu apellido">
                            </div>
                        </div>
                    </div>

                    <div class="input-group-premium" style="margin-top: 20px;">
                        <label>CORREO DE RECUPERACIÓN</label>
                        <div class="datos-input-wrapper">
                            <span class="material-icons-round datos-input-icon">mark_email_read</span>
                            <input type="email" id="perfil-correo" class="datos-input" placeholder="correo@alternativo.com">
                        </div>
                        <p class="datos-help-text">Se usará para restablecer tu contraseña si la olvidas.</p>
                    </div>

                    <div class="input-group-premium" style="margin-top: 20px;">
                        <label>TELÉFONO / WHATSAPP</label>
                        <div class="datos-input-wrapper">
                            <span class="material-icons-round datos-input-icon">phone_iphone</span>
                            <input type="tel" id="perfil-telefono" class="datos-input" placeholder="+57 300 000 0000">
                        </div>
                    </div>

                    <button type="submit" class="btn-submit-datos" id="btn-guardar-datos">
                        <span class="material-icons-round">save</span> GUARDAR CAMBIOS
                    </button>

                    <p id="datos-cooldown-msg" class="hidden" style="color: #ff9900; font-size: 0.8rem; text-align: center; margin-top: 15px; font-weight: bold;"></p>
                </form>
            </div>
        </div>
    `;

    // 2. LÓGICA DE CACHÉ
    const rawCache = localStorage.getItem('jeico_perfil_datos_v2');
    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');
    
    if (rawCache) {
        try {
            const cache = JSON.parse(rawCache);
            const edadCache = Date.now() - cache.timestamp;
            
            // Verificamos si los datos están llenos
            const estaLleno = (cache.datos.nombre && cache.datos.apellido && cache.datos.correo && cache.datos.telefono);
            const validezNecesaria = estaLleno ? TIEMPO_CACHE_COMPLETO : TIEMPO_CACHE_INCOMPLETO;

            if (edadCache < validezNecesaria) {
                document.getElementById('perfil-nombre').value = cache.datos.nombre || "";
                document.getElementById('perfil-apellido').value = cache.datos.apellido || "";
                document.getElementById('perfil-correo').value = cache.datos.correo || "";
                document.getElementById('perfil-telefono').value = cache.datos.telefono || "";
                
                document.getElementById('loading-datos').classList.add('hidden');
                document.getElementById('form-datos-perfil').classList.remove('hidden');
                
                console.log(`Carga offline. Perfil ${estaLleno ? 'Completo (24h)' : 'Incompleto (5m)'}.`);
                return; // Cortamos ejecución: CERO peticiones al servidor
            }
        } catch (e) {
            localStorage.removeItem('jeico_perfil_datos_v2');
        }
    }

    // 3. CONSULTA AL SERVIDOR (Solo si no hay caché o ya expiró)
    try {
        console.log("Consultando servidor para sincronizar perfil...");
        const res = await apiCall({ accion: 'getDatosPerfil', usuario: u, token: t });
        
        document.getElementById('loading-datos').classList.add('hidden');
        document.getElementById('form-datos-perfil').classList.remove('hidden');

        if (res.success && res.datos) {
            document.getElementById('perfil-nombre').value = res.datos.nombre || "";
            document.getElementById('perfil-apellido').value = res.datos.apellido || "";
            document.getElementById('perfil-correo').value = res.datos.correo || "";
            document.getElementById('perfil-telefono').value = res.datos.telefono || "";

            // Guardamos en LocalStorage
            localStorage.setItem('jeico_perfil_datos_v2', JSON.stringify({
                timestamp: Date.now(),
                datos: res.datos
            }));
        }
    } catch (e) {
        if (!rawCache) {
            document.getElementById('loading-datos').innerHTML = "<p style='color:#ff0055;'>Error de conexión al cargar datos.</p>";
        }
    }
}

async function actualizarMisDatos(e) {
    e.preventDefault();

    const nombre = document.getElementById('perfil-nombre').value.trim();
    const apellido = document.getElementById('perfil-apellido').value.trim();
    const correo = document.getElementById('perfil-correo').value.trim();
    const telefono = document.getElementById('perfil-telefono').value.trim();

    // 1. VALIDACIÓN ESTRICTA: Todos los campos requeridos
    if (!nombre || !apellido || !correo || !telefono) {
        return Swal.fire({
            icon: 'warning',
            title: 'Faltan Datos',
            text: 'Debes completar todos los campos para poder guardar los cambios.',
            background: '#0a0a0a', color: '#fff', confirmButtonColor: 'var(--accent)'
        });
    }

    const btn = document.getElementById('btn-guardar-datos');
    btn.innerHTML = '<span class="material-icons-round fa-spin">sync</span> GUARDANDO...';
    btn.disabled = true;

    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');

    try {
        const res = await apiCall({ 
            accion: 'setDatosPerfil', 
            usuario: u, 
            token: t,
            nombre, apellido, correo, telefono
        });

        if (res.success) {
            // ACTUALIZAMOS LOCALSTORAGE E INICIAMOS ENFRIAMIENTO DE 1 DÍA
            localStorage.setItem('jeico_perfil_datos_v2', JSON.stringify({
                timestamp: Date.now(),
                datos: { nombre, apellido, correo, telefono }
            }));

            Swal.fire({
                toast: true, position: 'top-end', icon: 'success',
                title: 'Perfil Guardado',
                text: 'Los datos se sincronizaron correctamente.',
                showConfirmButton: false, timer: 3000,
                background: '#0a0a0a', color: '#fff'
            });
        } else {
            Swal.fire({ icon: 'error', title: 'Error', text: res.msg, background: '#0a0a0a', color: '#fff' });
        }
    } catch (error) {
        Swal.fire({ icon: 'error', title: 'Error de Red', text: 'No se pudo conectar con el servidor.', background: '#0a0a0a', color: '#fff' });
    } finally {
        btn.innerHTML = '<span class="material-icons-round">save</span> GUARDAR CAMBIOS';
        btn.disabled = false;
    }
}

/**
 * ESTILOS INTEGRADOS
 */
const datosStyles = `
    .datos-wrapper-premium {
        max-width: 650px;
        margin: 0 auto;
        padding: 20px;
    }

    .card-datos {
        background: linear-gradient(145deg, #0a0a0a 0%, #050505 100%);
        border: 1px solid #1a1a1a;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    }

    .datos-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .input-group-premium {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .input-group-premium label {
        color: var(--accent);
        font-size: 0.75rem;
        font-weight: 800;
        letter-spacing: 1px;
    }

    .datos-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .datos-input-icon {
        position: absolute;
        left: 15px;
        color: #777;
        font-size: 20px;
        pointer-events: none;
    }

    .datos-input {
        width: 100%;
        background: #0d0d0d;
        border: 1px solid #222;
        color: #fff;
        padding: 16px 15px 16px 45px;
        border-radius: 12px;
        font-size: 0.95rem;
        outline: none;
        transition: 0.3s;
    }

    .datos-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 15px rgba(124, 58, 237, 0.2);
    }

    .btn-submit-datos {
        width: 100%;
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 18px;
        border-radius: 12px;
        font-weight: 800;
        letter-spacing: 1px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: 0.3s;
        margin-top: 30px;
    }

    .btn-submit-datos:hover {
        background: #6d28d9;
        transform: translateY(-3px);
    }

    .fa-spin { animation: spin 1s infinite linear; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @media (max-width: 600px) {
        .datos-grid { grid-template-columns: 1fr; }
    }
`;

const styleSheetDatos = document.createElement("style");
styleSheetDatos.innerText = datosStyles;
document.head.appendChild(styleSheetDatos);</script>
<script id="script-contra.js">/* contra.js */
/**
 * ===============================================================
 * CONTRA.JS - SISTEMA DE RECUPERACIÓN BLINDADO (CON CONTADOR)
 * ===============================================================
 */

// Variables temporales para la sesión de recuperación
let usuarioRecuperacionTemp = "";
let correoRecuperacionTemp = "";
let telRecuperacionTemp = "";
let recuEnCooldown = false;

/**
 * 1. MUESTRA LA PANTALLA PARA PEDIR EL CORREO Y TELÉFONO
 */
function mostrarRecuperacionPaso1() {
    document.getElementById('login-box-main').classList.add('hidden');
    document.getElementById('recover-step-1').classList.remove('hidden');
}

/**
 * 2. REGRESA AL LOGIN PRINCIPAL CANCELANDO LA RECUPERACIÓN
 */
function volverLogin() {
    document.getElementById('recover-step-1').classList.add('hidden');
    document.getElementById('recover-step-2').classList.add('hidden');
    document.getElementById('login-box-main').classList.remove('hidden');
}

/**
 * 3. PASO 1: VALIDA SI EL CORREO Y TELÉFONO COINCIDEN EN LA DB
 */
async function enviarSolicitudRecuperacion(e) {
    e.preventDefault();

    if (recuEnCooldown) return; // Si ya está bloqueado, no hace nada

    correoRecuperacionTemp = document.getElementById('rec-correo').value.trim();
    telRecuperacionTemp = document.getElementById('rec-tel').value.trim();
    const btn = document.getElementById('btn-recover-1');

    // VALIDACIÓN PREVIA
    if (!correoRecuperacionTemp.includes('@') || telRecuperacionTemp.length < 7) {
        return Swal.fire({ 
            icon: 'warning', title: 'Datos Inválidos', 
            text: 'Por favor ingresa un correo real y un teléfono válido.',
            background: '#0a0a0a', color: '#fff' 
        });
    }

    btn.innerHTML = '<span class="material-icons-round fa-spin">sync</span> VERIFICANDO...';
    btn.disabled = true;

    try {
        const res = await apiCall({ 
            accion: 'validarDatosRecuperacion', 
            correo: correoRecuperacionTemp, 
            telefono: telRecuperacionTemp 
        });

        if (res.success) {
            usuarioRecuperacionTemp = res.usuario; 
            
            document.getElementById('recover-step-1').classList.add('hidden');
            document.getElementById('recover-step-2').classList.remove('hidden');
            
            Swal.fire({ 
                icon: 'success', title: 'Identidad Verificada', 
                text: `Hola ${res.usuario}, ya puedes asignar tu nueva clave.`, 
                background: '#0a0a0a', color: '#fff', 
                confirmButtonColor: '#10b981', timer: 3000
            });
            
            btn.innerText = "ENVIAR DATOS";
            btn.disabled = false;
        } else {
            // FALLO: Activamos el candado visual de 1 minuto
            activarCooldownRecu(btn, "ENVIAR DATOS");
            
            Swal.fire({ 
                icon: 'error', title: 'No encontrado', 
                text: res.msg, 
                background: '#0a0a0a', color: '#fff' 
            });
        }
    } catch (err) {
        btn.innerText = "ENVIAR DATOS";
        btn.disabled = false;
        Swal.fire({ icon: 'error', title: 'Error de Red', text: 'No pudimos conectar con la base de datos.', background: '#0a0a0a', color: '#fff' });
    }
}

/**
 * LÓGICA DE CONTADOR DINÁMICO
 * Bloquea el botón y muestra los segundos restantes
 */
function activarCooldownRecu(btn, textoOriginal) {
    recuEnCooldown = true;
    btn.disabled = true;
    btn.classList.add('btn-locked');
    
    let segundos = 60;

    const interval = setInterval(() => {
        segundos--;
        btn.innerHTML = `<span class="material-icons-round">lock</span> ESPERA ${segundos}s`;

        if (segundos <= 0) {
            clearInterval(interval);
            recuEnCooldown = false;
            btn.disabled = false;
            btn.innerText = textoOriginal;
            btn.classList.remove('btn-locked');
        }
    }, 1000);
}

/**
 * 4. PASO 2: ENVÍA LA NUEVA CLAVE
 */
async function procesarNuevaClave(e) {
  e.preventDefault();
  
  const nuevaClave = document.getElementById('rec-nueva-clave').value.trim();
  const btn = document.getElementById('btn-recover-2');

  if(nuevaClave.length < 4) {
      return Swal.fire({ icon: 'warning', title: 'Clave muy corta', text: 'Mínimo 4 caracteres.', background: '#0a0a0a', color: '#fff' });
  }

  btn.innerHTML = '<span class="material-icons-round fa-spin">sync</span> ACTUALIZANDO...';
  btn.disabled = true;

  try {
      const res = await apiCall({ 
          accion: 'cambiarClaveOlvidada', 
          usuario: usuarioRecuperacionTemp, 
          correo: correoRecuperacionTemp,
          telefono: telRecuperacionTemp,
          nuevaClave: nuevaClave 
      });

      if (res.success) {
          Swal.fire({ 
              icon: 'success', title: '¡Proceso Exitoso!', 
              text: 'Tu contraseña ha sido actualizada. Ya puedes iniciar sesión.', 
              background: '#0a0a0a', color: '#fff', confirmButtonColor: '#7c3aed' 
          }).then(() => {
              document.getElementById('rec-correo').value = "";
              document.getElementById('rec-tel').value = "";
              document.getElementById('rec-nueva-clave').value = "";
              usuarioRecuperacionTemp = "";
              volverLogin();
          });
      } else {
          activarCooldownRecu(btn, "ACTUALIZAR CLAVE");
          Swal.fire({ icon: 'error', title: 'Error', text: res.msg, background: '#0a0a0a', color: '#fff' });
      }
  } catch (err) {
      btn.innerText = "ACTUALIZAR CLAVE";
      btn.disabled = false;
      Swal.fire({ icon: 'error', title: 'Falla Técnica', text: 'No se pudo actualizar.', background: '#0a0a0a', color: '#fff' });
  }
}

/**
 * ===============================================================
 * ESTILOS CSS PARA RECUPERACIÓN (ACTUALIZADOS CON ESTADO BLOQUEADO)
 * ===============================================================
 */
const contraStyles = `
    #recover-step-1 .input-field, 
    #recover-step-2 .input-field {
        width: 100%;
        background: #0d0d0d;
        border: 1px solid #222;
        color: #fff;
        padding: 15px;
        border-radius: 12px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        outline: none;
        margin-bottom: 10px;
    }

    #recover-step-1 .input-field:focus, 
    #recover-step-2 .input-field:focus {
        border-color: var(--accent);
        box-shadow: 0 0 15px rgba(124, 58, 237, 0.15);
        background: #000;
    }

    .btn-recover {
        width: 100%;
        padding: 16px;
        border-radius: 12px;
        border: none;
        font-weight: 800;
        letter-spacing: 1px;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    /* Estilo cuando el botón está bloqueado por el cronómetro */
    .btn-recover.btn-locked {
        background: #1a1a1a !important;
        color: #444 !important;
        border: 1px solid #222 !important;
        cursor: not-allowed;
    }

    .fa-spin { animation: spin 1s infinite linear; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .back-to-login {
        display: block;
        text-align: center;
        margin-top: 20px;
        color: #555;
        font-size: 0.75rem;
        text-decoration: none;
        font-weight: 600;
        letter-spacing: 1px;
        cursor: pointer;
        transition: 0.3s;
    }
    .back-to-login:hover { color: var(--accent); }
`;

const styleSheetContra = document.createElement("style");
styleSheetContra.innerText = contraStyles;
document.head.appendChild(styleSheetContra);</script>
<script id="script-ranking.js">/* ranking.js */
/**
 * ===============================================================
 * RANKING.JS - TABLA DE LÍDERES (OPTIMIZADA CON CACHÉ DIARIA)
 * ===============================================================
 */

let cargandoRanking = false;

/**
 * 1. FUNCIÓN PRINCIPAL: Cargar datos del Ranking
 */
async function cargarRanking() {
    if (cargandoRanking) return;
    cargandoRanking = true;

    // --- PREPARAR CONTENEDOR ---
    const mainSection = document.getElementById('sec-ranking');
    let container = document.getElementById('ranking-content');
    
    if (!container && mainSection) {
        mainSection.innerHTML = '<div id="ranking-content" class="ranking-wrapper"></div>';
        container = document.getElementById('ranking-content');
    }
    
    if (!container) {
        cargandoRanking = false;
        return; 
    }

    // --- LÓGICA DE CACHÉ INTELIGENTE (12 AM RULE) ---
    const hoy = new Date().toLocaleDateString(); // Ej: "19/2/2026"
    const fechaGuardada = localStorage.getItem('jeico_ranking_date');
    const cacheRanking = localStorage.getItem('jeico_ranking_data');
    
    // Verificamos si tenemos datos y si corresponden al día de hoy
    const datosSonDeHoy = (fechaGuardada === hoy);

    if (cacheRanking && datosSonDeHoy) {
        console.log("Ranking: Cargando desde caché (Datos de hoy).");
        const datos = JSON.parse(cacheRanking);
        renderRankingUI(container, datos.top10, datos.miRanking);
        cargandoRanking = false;
        return; // ¡TERMINAMOS AQUÍ! No consumimos API.
    }

    // --- SI NO HAY CACHÉ O ES UN DÍA NUEVO -> CARGAR DEL SERVIDOR ---
    
    // Loader solo si vamos a buscar datos nuevos
    container.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:300px;">
            <div class="spinner"></div>
            <p style="color:#888; margin-top:20px; font-family: 'Righteous', sans-serif; letter-spacing: 2px;">ACTUALIZANDO POSICIONES...</p>
        </div>
    `;

    try {
        const u = localStorage.getItem('jeico_user');
        const t = localStorage.getItem('jeico_token');

        if (!u || !t) {
            container.innerHTML = `<p style="text-align:center; color:var(--danger);">Sesión no válida.</p>`;
            cargandoRanking = false;
            return;
        }

        const res = await apiCall({ 
            accion: 'getRanking', 
            usuario: u, 
            token: t 
        });

        if (res && res.success) {
            // Guardamos datos y LA FECHA DE HOY
            localStorage.setItem('jeico_ranking_data', JSON.stringify(res));
            localStorage.setItem('jeico_ranking_date', hoy);
            
            renderRankingUI(container, res.top10, res.miRanking);
        } else {
            // Si falla la red pero teníamos una caché vieja (de ayer), la mostramos como respaldo
            if (cacheRanking) {
                const datosViejos = JSON.parse(cacheRanking);
                renderRankingUI(container, datosViejos.top10, datosViejos.miRanking);
                Swal.fire({ toast: true, position: 'top-end', icon: 'warning', title: 'Mostrando datos anteriores (Sin conexión)', showConfirmButton: false, timer: 3000 });
            } else {
                container.innerHTML = `<p style="text-align:center; color:var(--danger);">Error al cargar el ranking.</p>`;
            }
        }

    } catch (error) {
        if (cacheRanking) {
            const datosViejos = JSON.parse(cacheRanking);
            renderRankingUI(container, datosViejos.top10, datosViejos.miRanking);
        } else {
            container.innerHTML = `<p style="text-align:center; color:var(--danger);">Fallo de conexión.</p>`;
        }
    } finally {
        cargandoRanking = false;
    }
}

/**
 * 2. RENDERIZADO UI: Construir la interfaz épica
 */
function renderRankingUI(container, top10, miData) {
    container.innerHTML = "";

    // --- A. TARJETA DEL USUARIO ACTUAL (MI ESTADÍSTICA) ---
    const divMiStats = document.createElement('div');
    divMiStats.className = 'my-stats-card';
    
    // Determinar mensaje según posición
    let mensajeAnimo = "¡Sigue comprando para subir!";
    let iconoPosicion = "trending_up";
    let clasePosicion = "";

    if (miData.posicion === 1) { 
        mensajeAnimo = "¡ERES EL REY DEL STREAMING! 👑"; 
        iconoPosicion = "emoji_events";
        clasePosicion = "rank-1-text";
    } else if (miData.posicion > 0 && miData.posicion <= 3) {
        mensajeAnimo = "¡Estás en el podio! Mantén el ritmo.";
        iconoPosicion = "military_tech";
    } else if (miData.posicion > 0 && miData.posicion <= 10) {
        mensajeAnimo = "¡Eres un Top Seller! Estás en la élite.";
        iconoPosicion = "star";
    } else if (miData.posicion === -1) {
        mensajeAnimo = "Realiza tu primera compra para entrar al Ranking.";
    }

    divMiStats.innerHTML = `
        <div class="my-stats-header">
            <span class="material-icons-round" style="color:var(--accent);">account_circle</span>
            <span>TU RENDIMIENTO</span>
        </div>
        <div class="my-stats-grid">
            <div class="stat-item">
                <div class="stat-label">POSICIÓN GLOBAL</div>
                <div class="stat-value ${clasePosicion}">#${miData.posicion > 0 ? miData.posicion : '-'}</div>
            </div>
            <div class="stat-item border-left">
                <div class="stat-label">CUENTAS COMPRADAS</div>
                <div class="stat-value text-accent">${miData.compras}</div>
            </div>
        </div>
        <div class="my-stats-footer">
            <span class="material-icons-round">${iconoPosicion}</span> ${mensajeAnimo}
        </div>
    `;
    container.appendChild(divMiStats);

    // --- B. LISTA DEL TOP 10 ---
    const divLeaderboard = document.createElement('div');
    divLeaderboard.className = 'leaderboard-container';
    
    let htmlList = `<h3 class="leaderboard-title">🏆 TOP 10 LÍDERES</h3><div class="leaderboard-list">`;

    if(top10.length === 0) {
        htmlList += `<p style="text-align:center; padding:20px; color:#666;">Aún no hay datos registrados hoy.</p>`;
    } else {
        top10.forEach((user, index) => {
            const rank = index + 1;
            let rankClass = "rank-item";
            let iconHtml = `<span class="rank-number">#${rank}</span>`;
            
            // Estilos especiales para el podio
            if (rank === 1) {
                rankClass += " rank-gold";
                iconHtml = `<span class="material-icons-round medal-icon gold">emoji_events</span>`;
            } else if (rank === 2) {
                rankClass += " rank-silver";
                iconHtml = `<span class="material-icons-round medal-icon silver">military_tech</span>`;
            } else if (rank === 3) {
                rankClass += " rank-bronze";
                iconHtml = `<span class="material-icons-round medal-icon bronze">military_tech</span>`;
            }

            // Resaltar si soy yo
            if (user.usuario === miData.usuario) {
                rankClass += " its-me";
            }

            htmlList += `
                <div class="${rankClass}">
                    <div class="rank-left">
                        ${iconHtml}
                        <span class="rank-name">${user.usuario}</span>
                    </div>
                    <div class="rank-right">
                        <span class="rank-score">${user.compras}</span>
                        <span class="rank-label">Ventas</span>
                    </div>
                </div>
            `;
        });
    }

    htmlList += `</div>`;
    divLeaderboard.innerHTML = htmlList;
    container.appendChild(divLeaderboard);

    // --- C. DISCLAIMER DE ACTUALIZACIÓN ---
    const divDisclaimer = document.createElement('div');
    divDisclaimer.className = 'ranking-disclaimer';
    divDisclaimer.innerHTML = `
        <span class="material-icons-round" style="font-size: 1rem;">update</span>
        Los datos se actualizan automáticamente todos los días a las 12:00 AM (Medianoche).
    `;
    container.appendChild(divDisclaimer);
}

/**
 * ===============================================================
 * ESTILOS CSS PREMIUM (INYECTADOS)
 * ===============================================================
 */
const rankingStyles = `
    .ranking-wrapper {
        padding: 10px;
        max-width: 800px;
        margin: 0 auto;
        animation: fadeIn 0.5s ease;
    }

    /* --- DISCLAIMER --- */
    .ranking-disclaimer {
        margin-top: 20px;
        text-align: center;
        font-size: 0.75rem;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.02);
        padding: 10px;
        border-radius: 8px;
        border: 1px dashed #333;
    }

    /* --- MI TARJETA --- */
    .my-stats-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
        border: 1px solid #333;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        position: relative;
        overflow: hidden;
    }
    
    /* Efecto de brillo superior */
    .my-stats-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; width: 100%; height: 4px;
        background: linear-gradient(90deg, var(--accent), #b721ff);
    }

    .my-stats-header {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Righteous', sans-serif;
        color: #fff;
        font-size: 1.2rem;
        margin-bottom: 20px;
        opacity: 0.9;
    }

    .my-stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .stat-item {
        text-align: center;
    }
    
    .border-left {
        border-left: 1px solid rgba(255,255,255,0.1);
    }

    .stat-label {
        color: #666;
        font-size: 0.7rem;
        font-weight: 800;
        letter-spacing: 2px;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: #fff;
        line-height: 1;
    }
    
    .text-accent { color: var(--accent); text-shadow: 0 0 20px rgba(124, 58, 237, 0.4); }
    .rank-1-text { color: #FFD700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }

    .my-stats-footer {
        margin-top: 20px;
        background: rgba(255,255,255,0.03);
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-size: 0.85rem;
        color: #aaa;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* --- LEADERBOARD --- */
    .leaderboard-container {
        background: #000;
        border-radius: 16px;
        border: 1px solid #222;
        padding: 20px;
    }

    .leaderboard-title {
        text-align: center;
        font-family: 'Righteous', sans-serif;
        color: #fff;
        margin-top: 0;
        margin-bottom: 20px;
        letter-spacing: 1px;
        text-transform: uppercase;
        background: -webkit-linear-gradient(#fff, #888);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .leaderboard-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .rank-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #111;
        padding: 12px 15px;
        border-radius: 10px;
        border: 1px solid transparent;
        transition: transform 0.2s;
    }
    
    .rank-item:hover {
        transform: translateX(5px);
        background: #161616;
    }

    .rank-left { display: flex; align-items: center; gap: 15px; }
    .rank-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }

    .rank-number {
        font-family: 'Righteous', sans-serif;
        color: #444;
        font-size: 1.2rem;
        width: 30px;
        text-align: center;
    }

    .rank-name {
        font-weight: 600;
        color: #eee;
        font-size: 0.95rem;
    }

    .rank-score {
        font-weight: 800;
        color: #fff;
        font-size: 1.1rem;
    }
    
    .rank-label {
        font-size: 0.6rem;
        color: #555;
        text-transform: uppercase;
        font-weight: 700;
    }

    /* --- MEDALLAS Y COLORES --- */
    .medal-icon { font-size: 1.5rem; width: 30px; text-align: center; }
    .gold { color: #FFD700; filter: drop-shadow(0 0 5px rgba(255,215,0,0.5)); }
    .silver { color: #C0C0C0; filter: drop-shadow(0 0 5px rgba(192,192,192,0.5)); }
    .bronze { color: #CD7F32; filter: drop-shadow(0 0 5px rgba(205,127,50,0.5)); }

    /* Estilos de fila Top 3 */
    .rank-gold {
        background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent);
        border: 1px solid rgba(255,215,0,0.3);
    }
    .rank-silver {
        background: linear-gradient(90deg, rgba(192,192,192,0.05), transparent);
        border: 1px solid rgba(192,192,192,0.2);
    }
    .rank-bronze {
        background: linear-gradient(90deg, rgba(205,127,50,0.05), transparent);
        border: 1px solid rgba(205,127,50,0.2);
    }

    /* Highlight del propio usuario */
    .its-me {
        border: 1px solid var(--accent);
        box-shadow: 0 0 15px rgba(124, 58, 237, 0.2) inset;
    }
    .its-me .rank-name { color: var(--accent); }
`;

const styleSheetRanking = document.createElement("style");
styleSheetRanking.innerText = rankingStyles;
document.head.appendChild(styleSheetRanking);

// --- OBSERVER PARA CARGAR AL ABRIR LA PESTAÑA ---
document.addEventListener('DOMContentLoaded', () => {
    const secRanking = document.getElementById('sec-ranking');
    
    if (secRanking) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    if (!secRanking.classList.contains('hidden')) {
                        cargarRanking();
                    }
                }
            });
        });
        observer.observe(secRanking, { attributes: true });
    }
});</script>
<script id="script-script.js">/* script.js */
/**
 * ===============================================================
 * MAIN.JS - NÚCLEO PRO (ULTRA-SYNC + PANTALLA DE CARGA)
 * ===============================================================
 */

// ============================================
// ⚠️ URL DE TU API GOOGLE APPS SCRIPT ⚠️
const API_URL = "https://script.google.com/macros/s/AKfycbxO3Cxp48sMVrhz6nlViSudvJ8GTB1aM_4N91L3kVeLBPuRRmwtYme2Y1d0Yzgw9LCDNA/exec";
// ============================================

// --- CONFIGURACIÓN DE ENFRIAMIENTO ---
const TIEMPO_ENFRIAMIENTO = 5 * 60 * 1000; // 5 Minutos para F5
const COOLDOWN_LOGIN_ERROR = 15; // 15 Segundos por error de login

// --- ESTADO GLOBAL ---
let cart = []; 
let userBalance = 0;
let loginEnCooldown = false;

// --- API FETCH ---
async function apiCall(params) {
  const url = new URL(API_URL);
  Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
  try { 
    const response = await fetch(url);
    return await response.json(); 
  } catch (e) { 
    console.error("Error API:", e);
    return { success: false, msg: "Error de conexión con el servidor" }; 
  }
}

// --- INICIO / COMPROBACIÓN DE SESIÓN ---
document.addEventListener('DOMContentLoaded', () => {
  const t = localStorage.getItem('jeico_token');
  const u = localStorage.getItem('jeico_user');
  
  if(t && u) {
    mostrarApp(u);
  } else {
    document.getElementById('login-view').style.display = 'flex';
    document.getElementById('app-view').style.display = 'none';
  }

  // --- CERRAR MENÚ HAMBURGUESA AL HACER CLIC FUERA ---
  document.addEventListener('click', (e) => {
    const sidebar = document.querySelector('.sidebar');
    const btn = document.getElementById('hamburger-btn');
    
    if (window.innerWidth <= 768 && 
        sidebar && sidebar.classList.contains('open') && 
        !sidebar.contains(e.target) && 
        !btn.contains(e.target)) {
      sidebar.classList.remove('open');
    }
  });
});

// --- LÓGICA DE LOGIN CON ESCUDO DE 15 SEG ---
document.getElementById('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (loginEnCooldown) return; 

  const u = document.getElementById('user').value.trim();
  const p = document.getElementById('pass').value.trim();
  const btn = document.querySelector('.btn-login'); 
  
  btn.innerText = "VERIFICANDO...";
  btn.disabled = true;
  
  try {
    const res = await apiCall({ accion: 'login', usuario: u, clave: p });
    
    if(res.success) {
      localStorage.setItem('jeico_token', res.token);
      localStorage.setItem('jeico_user', res.usuario);
      localStorage.setItem('jeico_saldo', res.saldo);
      localStorage.setItem('jeico_last_sync_balance', Date.now());
      
      // Inicializamos marca de pestaña
      sessionStorage.setItem('jeico_tab_initialized', 'true');
      
      btn.innerText = "ENTRAR";
      btn.disabled = false;
      mostrarApp(res.usuario, res.saldo);
    } else {
      activarCooldownLogin(btn);
      Swal.fire({
          title: 'Acceso Denegado',
          text: res.msg,
          icon: 'error',
          background: '#0a0a0a',
          color: '#fff',
          confirmButtonColor: '#7c3aed'
      });
    }
  } catch (error) {
    btn.innerText = "ENTRAR";
    btn.disabled = false;
    Swal.fire({ icon: 'error', title: 'Error de Red', text: 'Servidor no disponible.', background: '#0a0a0a', color: '#fff' });
  }
});

function activarCooldownLogin(btn) {
    loginEnCooldown = true;
    btn.disabled = true;
    let segundos = COOLDOWN_LOGIN_ERROR;

    const interval = setInterval(() => {
        segundos--;
        btn.innerHTML = `<span class="material-icons-round" style="font-size:1rem; vertical-align:middle;">lock</span> ESPERA ${segundos}s`;

        if (segundos <= 0) {
            clearInterval(interval);
            loginEnCooldown = false;
            btn.disabled = false;
            btn.innerText = "ENTRAR";
        }
    }, 1000);
}

/**
 * PANTALLA DE CARGA GLOBAL (BLOQUEO)
 */
function mostrarLoadingGlobal() {
    const loader = document.createElement('div');
    loader.id = 'loading-global-overlay';
    loader.innerHTML = `
        <div class="loader-content">
            <div class="spinner-global"></div>
            <h2 style="color:#fff; margin-top:25px; letter-spacing:5px; font-size:0.85rem; font-weight:900; text-transform:uppercase;">Autenticando Acceso</h2>
            <p style="color:#555; font-size:0.65rem; margin-top:10px; letter-spacing:2px; font-weight:bold;">SINCRONIZANDO DATOS DE BÓVEDA...</p>
        </div>
    `;
    document.body.appendChild(loader);
}

function ocultarLoadingGlobal() {
    const loader = document.getElementById('loading-global-overlay');
    if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => loader.remove(), 400);
    }
}

/**
 * Función que orquestra la entrada y la sincronización inicial
 */
async function mostrarApp(user, saldo) {
  document.getElementById('login-view').style.display = 'none';
  document.getElementById('app-view').style.display = 'block';
  document.getElementById('display-user').innerText = user;
  
  const isNewTab = !sessionStorage.getItem('jeico_tab_initialized');

  if (saldo !== undefined) {
    userBalance = Number(saldo);
    localStorage.setItem('jeico_saldo', userBalance);
  } else {
    userBalance = Number(localStorage.getItem('jeico_saldo')) || 0;
  }

  if (isNewTab) {
      // 🚀 CASO PESTAÑA NUEVA: Bloqueo de pantalla y Sincronización Forzada de los 5 Módulos
      mostrarLoadingGlobal();
      sessionStorage.setItem('jeico_tab_initialized', 'true');
      
      try {
          await Promise.all([
              sincronizarSaldo(),
              cargarTienda(true),
              typeof cargarPedidos === 'function' ? cargarPedidos(true) : Promise.resolve(),
              typeof cargarBilletera === 'function' ? cargarBilletera(true) : Promise.resolve(),
              typeof cargarMisTickets === 'function' ? cargarMisTickets(true) : Promise.resolve()
          ]);
      } catch (err) {
          console.error("Falla en sincronización masiva:", err);
      } finally {
          ocultarLoadingGlobal();
      }
  } else {
      // ♻️ CASO F5: Respetamos enfriamiento de 5 min
      const lastSync = localStorage.getItem('jeico_last_sync_balance');
      if (!lastSync || (Date.now() - lastSync > TIEMPO_ENFRIAMIENTO)) {
          sincronizarSaldo(); 
      }
  }
  
  updateBalanceUI();
  nav('inicio', document.querySelector('.nav-item[onclick*="inicio"]'));
}

async function sincronizarSaldo() {
    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');
    if (!u || !t) return;

    try {
        const res = await apiCall({ accion: 'getSaldo', usuario: u, token: t });
        if (res.success) {
            userBalance = Number(res.saldo);
            localStorage.setItem('jeico_saldo', userBalance);
            localStorage.setItem('jeico_last_sync_balance', Date.now());
            updateBalanceUI();
        } else if (res.msg === "Sesión inválida") {
            logout();
        }
    } catch (e) { console.error("Error balance sync"); }
}

function updateBalanceUI() {
    const formatted = `$ ${new Intl.NumberFormat('es-CO').format(userBalance)}`;
    const displayBal = document.getElementById('display-balance');
    if(displayBal) displayBal.innerText = formatted;
    
    const bigWallet = document.getElementById('wallet-balance-big');
    if(bigWallet) bigWallet.innerText = formatted;
}

function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    if(sidebar) sidebar.classList.toggle('open');
}

/**
 * NAVEGACIÓN ENTRE SECCIONES
 */
function nav(sec, el) {
    if (el && !el.classList.contains('submenu-item')) {
        document.querySelectorAll('.nav-links > .nav-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
    }
    
    const secciones = ['inicio', 'tienda', 'pedidos', 'recarga', 'soporte', 'billetera', 'codigos', 'datos', 'mistickets', 'ranking'];
    secciones.forEach(id => {
        const elem = document.getElementById('sec-' + id);
        if(elem) elem.classList.add('hidden');
    });
    
    const section = document.getElementById('sec-' + sec);
    if(section) {
        section.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    if (window.innerWidth <= 768) {
        const sidebar = document.querySelector('.sidebar');
        if(sidebar) sidebar.classList.remove('open');
    }

    const cartBtn = document.getElementById('main-cart-btn');
    const cartDrawer = document.getElementById('cart-drawer');
    const cartOverlay = document.getElementById('cart-overlay');

    if (sec === 'tienda') {
        cartBtn?.classList.remove('hidden');
        cargarTienda(); 
    } else {
        cartBtn?.classList.add('hidden');
        if(cartDrawer) cartDrawer.classList.remove('open');
        if(cartOverlay) cartOverlay.classList.add('hidden');
    }
    
    if (sec === 'pedidos') if(typeof cargarPedidos === 'function') cargarPedidos();
    if (sec === 'billetera') if(typeof cargarBilletera === 'function') cargarBilletera();
    if (sec === 'recarga') if(typeof cargarRecarga === 'function') cargarRecarga();
    if (sec === 'soporte') if(typeof cargarSoporte === 'function') cargarSoporte(); 
    if (sec === 'codigos') if(typeof cargarCodigos === 'function') cargarCodigos(); 
    if (sec === 'datos') if(typeof cargarDatos === 'function') cargarDatos(); 
    if (sec === 'mistickets') if(typeof cargarMisTickets === 'function') cargarMisTickets();
    if (sec === 'ranking' && typeof cargarRanking === 'function') cargarRanking();
}

/**
 * Lógica de tienda
 */
async function cargarTienda(forzar = false) {
  const container = document.getElementById('shop-container');
  if(!container) return;

  const lastSyncStore = localStorage.getItem('jeico_last_sync_store');
  const cachedStore = localStorage.getItem('jeico_store_cache');

  if (!forzar && cachedStore && lastSyncStore && (Date.now() - lastSyncStore < TIEMPO_ENFRIAMIENTO)) {
      renderizarTiendaDesdeDatos(JSON.parse(cachedStore));
      return;
  }

  container.innerHTML = '<div class="spinner"></div>';
  const u = localStorage.getItem('jeico_user');
  const t = localStorage.getItem('jeico_token');
  
  const res = await apiCall({ accion: 'getTienda', usuario: u, token: t });
  
  if(res.success) {
      userBalance = Number(res.saldo); 
      updateBalanceUI();
      localStorage.setItem('jeico_store_cache', JSON.stringify(res.productos));
      localStorage.setItem('jeico_last_sync_store', Date.now());
      localStorage.setItem('jeico_saldo', userBalance);
      renderizarTiendaDesdeDatos(res.productos);
  }
}

function renderizarTiendaDesdeDatos(productos) {
    const container = document.getElementById('shop-container');
    if(!container) return;
    container.innerHTML = "";
    productos.forEach(p => {
        let img = p.img;
        if(img && img.includes('drive')) {
            const id = img.match(/\/d\/([a-zA-Z0-9_-]+)/) || img.match(/id=([a-zA-Z0-9_-]+)/);
            if(id) img = `https://drive.google.com/thumbnail?id=${id[1]}&sz=w400`;
        }
        const isSoldOut = p.stock <= 0;
        const btnHtml = isSoldOut 
            ? `<button class="btn-buy disabled" disabled>AGOTADO</button>`
            : `<button class="btn-buy" onclick="addToCart('${p.nombre}', ${p.precio}, '${img}')">AGREGAR</button>`;
        
        container.innerHTML += `
            <div class="product-card ${isSoldOut ? 'sold-out' : ''}">
              <div class="card-img-container"><img src="${img || ''}" class="card-img"></div>
              <div class="card-body">
                <div class="card-title">${p.nombre}</div>
                <span class="card-price">$ ${new Intl.NumberFormat('es-CO').format(p.precio)}</span>
                <div class="card-stock">${isSoldOut ? 'SIN STOCK' : p.stock + ' disponibles'}</div>
                ${btnHtml}
              </div>
            </div>`;
    });
}

function addToCart(nombre, precio, img) {
    const existe = cart.find(item => item.nombre === nombre);
    if(existe) { existe.cantidad++; } 
    else { cart.push({ nombre, precio, img, cantidad: 1 }); }
    updateCartUI();
    Toast.fire({ icon: 'success', title: 'Añadido al carrito' });
}

function updateCartUI() {
    const list = document.getElementById('cart-items-list');
    const badge = document.getElementById('cart-count');
    const totalDisplay = document.getElementById('cart-total-display');
    if(!list) return;
    list.innerHTML = "";
    let total = 0, count = 0;

    if(cart.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#555; margin-top:20px;">Tu carrito está vacío.</p>';
    } else {
        cart.forEach((item, index) => {
            total += item.precio * item.cantidad;
            count += item.cantidad;
            list.innerHTML += `
                <div class="cart-item-row">
                    <img src="${item.img}" class="cart-item-img">
                    <div class="cart-item-info" style="flex-grow:1;">
                        <h4>${item.nombre}</h4>
                        <div class="cart-item-price">$ ${new Intl.NumberFormat('es-CO').format(item.precio)}</div>
                        <span>Cantidad: ${item.cantidad}</span>
                    </div>
                    <button class="btn-remove" onclick="removeFromCart(${index})">
                        <span class="material-icons-round">delete</span>
                    </button>
                </div>`;
        });
    }
    if(badge) badge.innerText = count;
    if(totalDisplay) totalDisplay.innerText = `$ ${new Intl.NumberFormat('es-CO').format(total)}`;
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartUI();
}

function toggleCart() {
    const drawer = document.getElementById('cart-drawer');
    const overlay = document.getElementById('cart-overlay');
    if(drawer) drawer.classList.toggle('open');
    if(overlay) overlay.classList.toggle('hidden');
}

/**
 * PROCESO DE COMPRA (SINCRONIZACIÓN POST-PAGO MEJORADA)
 */
async function finalizePurchase() {
    let total = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    if(userBalance < total) {
        return Swal.fire({ title: 'Saldo Insuficiente', icon: 'error', background: '#0a0a0a', color: '#fff' });
    }

    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');
    
    Swal.fire({ 
        title: 'PROCESANDO PAGO', text: 'Generando credenciales...',
        didOpen: () => Swal.showLoading(), background: '#0a0a0a', color:'#fff', allowOutsideClick: false
    });

    let exitos = 0;
    for (const item of cart) {
        for(let i=0; i<item.cantidad; i++) {
            const res = await apiCall({ accion: 'comprar', usuario: u, token: t, producto: item.nombre });
            if(res.success) {
                exitos++;
                userBalance = res.nuevoSaldo; 
                localStorage.setItem('jeico_saldo', userBalance); 
            }
        }
    }

    if(exitos > 0) {
        cart = []; updateCartUI();
        
        // --- MEJORA: INVALIDAR CACHÉS PARA FORZAR ACTUALIZACIÓN REAL EN PESTAÑAS ---
        localStorage.removeItem('jeico_last_sync_store');
        localStorage.removeItem('jeico_last_sync_balance');
        localStorage.removeItem('jeico_last_sync_orders');
        localStorage.removeItem('jeico_wallet_cache_v2'); // Limpiamos billetera para ver saldo real
        
        if(typeof closeCheckout === 'function') closeCheckout();
        updateBalanceUI();
        
        // Llamamos a cargarTienda pero sin el 'true' para no bloquear la pantalla
        // El otro JS se encargará de la resta visual suave.
        if(typeof cargarTienda === 'function') cargarTienda(); 
        
        Swal.fire({ title: '¡PAGO COMPLETADO!', text: 'Cuentas generadas con éxito. Revisa tus Pedidos.', icon: 'success', background: '#0a0a0a', color:'#fff', confirmButtonColor: '#7c3aed' });
    }
}

function toggleSubmenu(elemento) {
    const submenu = elemento.nextElementSibling;
    if (submenu && submenu.classList.contains('submenu')) {
        submenu.classList.toggle('hidden');
        elemento.classList.toggle('open');
    }
}

function logout() {
    localStorage.clear();
    sessionStorage.clear(); 
    location.reload();
}

// Toggle visual de contraseña
document.addEventListener('DOMContentLoaded', () => {
    const togglePassword = document.querySelector('#togglePassword');
    const passwordField = document.querySelector('#pass');
    if (togglePassword && passwordField) {
        togglePassword.addEventListener('click', function () {
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            this.textContent = type === 'password' ? 'visibility_off' : 'visibility';
        });
    }
});

/**
 * ESTILOS INYECTADOS PARA EL LOADER GLOBAL (OVERLAY GRIS)
 */
const styleGlobalLoader = document.createElement('style');
styleGlobalLoader.innerHTML = `
    #loading-global-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #0a0a0a; display: flex; align-items: center; justify-content: center;
        z-index: 9999999; transition: opacity 0.4s ease;
    }
    .loader-content { text-align: center; }
    .spinner-global {
        width: 60px; height: 60px; border: 4px solid rgba(124, 58, 237, 0.1);
        border-top-color: #7c3aed; border-radius: 50%;
        animation: spin-global 1s linear infinite; margin: 0 auto;
        box-shadow: 0 0 20px rgba(124, 58, 237, 0.2);
    }
    @keyframes spin-global { to { transform: rotate(360deg); } }
`;
document.head.appendChild(styleGlobalLoader);</script>
<script id="script-soporte.js">/* soporte.js */
/**
 * ===============================================================
 * SOPORTE.JS - CENTRO DE AYUDA PREMIUM (FAQ & TICKETS MANUAL)
 * ===============================================================
 */

// Icono de WhatsApp (Opcional)
const WSP_SOPORTE_ICON_URL = `https://drive.google.com/thumbnail?id=12_hw1hRhhGNGv1UY7CX-YJajITFtrY-S&sz=w200`;

/**
 * 1. FUNCIÓN PRINCIPAL DE CARGA
 */
function cargarSoporte() {
    const container = document.getElementById('sec-soporte');
    
    container.innerHTML = `
        <div class="soporte-wrapper-premium">
            <div class="page-header-premium" style="text-align: center; margin-bottom: 40px;">
                <h1 class="page-title">CENTRO DE AYUDA</h1>
                <p class="page-subtitle">Resolvemos tus dudas y garantizamos tu entretenimiento.</p>
            </div>

            <div class="support-grid">
                <div class="support-contact-card">
                    <div class="support-card-header">
                        <span class="material-icons-round" style="font-size: 3rem; color: var(--accent);">support_agent</span>
                        <h3>SOPORTE TÉCNICO</h3>
                        <p>Atención prioritaria 24/7 para tus solicitudes.</p>
                    </div>
                    
                    <div class="support-action-buttons">
                        <button onclick="abrirModalTicket('FALLA DE ACCESO')" class="btn-ticket">
                            <span class="material-icons-round">gpp_maybe</span>
                            REPORTAR FALLA DE ACCESO
                        </button>
                        <button onclick="abrirModalTicket('RENOVACIÓN')" class="btn-ticket">
                            <span class="material-icons-round">autorenew</span>
                            SOLICITAR RENOVACIÓN
                        </button>
                        <button onclick="abrirModalTicket('DUDA / OTRO')" class="btn-ticket outline">
                            <span class="material-icons-round">help_outline</span>
                            OTRA CONSULTA
                        </button>
                    </div>
                    
                    <div class="warranty-info">
                        <span class="material-icons-round">verified</span>
                        <span>¿Tienes algún inconveniente? Cuentas con nuestro <b>respaldo y atención</b>.</span>
                    </div>
                </div>

                <div class="faq-container">
                    <h3 class="faq-title">PREGUNTAS FRECUENTES</h3>
                    
                    <div class="faq-item" onclick="toggleFAQ(this)">
                        <div class="faq-question">
                            <span>¿Cuánto tarda en entregarse una cuenta?</span>
                            <span class="material-icons-round arrow">expand_more</span>
                        </div>
                        <div class="faq-answer">
                            El sistema es automatizado. Al comprar en la tienda con tu saldo, la cuenta se refleja inmediatamente en tu sección de "Mis Pedidos".
                        </div>
                    </div>

                    <div class="faq-item" onclick="toggleFAQ(this)">
                        <div class="faq-question">
                            <span>¿Qué hago si alguien cambió la contraseña?</span>
                            <span class="material-icons-round arrow">expand_more</span>
                        </div>
                        <div class="faq-answer">
                            No te preocupes. Usa el botón de la pestaña "codigos" alli podras solicitar un codigo y cambiar la clave de tu cuenta de no ser posible puedes optar por "Reportar Falla de Acceso" desde esta pantalla y nuestro equipo te reestablecerá el servicio rápidamente.
                        </div>
                    </div>

                    <div class="faq-item" onclick="toggleFAQ(this)">
                        <div class="faq-question">
                            <span>¿Puedo modificar los perfiles?</span>
                            <span class="material-icons-round arrow">expand_more</span>
                        </div>
                        <div class="faq-answer">
                            Está estrictamente prohibido cambiar contraseñas, correos o nombres de perfiles que no te correspondan. Hacerlo anula la garantía.
                        </div>
                    </div>

                    <div class="faq-item" onclick="toggleFAQ(this)">
                        <div class="faq-question">
                            <span>¿En cuántos dispositivos puedo ver?</span>
                            <span class="material-icons-round arrow">expand_more</span>
                        </div>
                        <div class="faq-answer">
                            Cada compra equivale a un (1) perfil o pantalla, el cual es válido para reproducir en un (1) solo dispositivo en simultáneo. Compartir la cuenta puede causar bloqueos.
                        </div>
                    </div>

                    <div class="faq-item" onclick="toggleFAQ(this)">
                        <div class="faq-question">
                            <span>¿Cómo renuevo mi suscripción?</span>
                            <span class="material-icons-round arrow">expand_more</span>
                        </div>
                        <div class="faq-answer">
                            Las cuentas tienen una duración de 30 días. Para seguir disfrutando, puedes volver a comprar en la tienda o usar el botón "Solicitar Renovación" si deseas intentar mantener tu perfil actual.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="ticket-modal-overlay" class="ticket-overlay hidden">
            <div class="ticket-modal-content">
                <div class="ticket-modal-header">
                    <h2>NUEVO TICKET</h2>
                    <button class="btn-close-ticket" onclick="cerrarModalTicket()">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
                <div class="ticket-modal-body">
                    <p class="ticket-help-text">Por favor, detalla tu solicitud para que podamos ayudarte más rápido.</p>
                    
                    <div class="input-group-premium">
                        <label>TIPO DE SOLICITUD</label>
                        <input type="text" id="ticket-tipo" class="ticket-input readonly" readonly>
                    </div>

                    <div class="input-group-premium">
                        <label>CUENTA A REPORTAR (Opcional)</label>
                        <input type="text" id="ticket-cuenta-input" class="ticket-input" placeholder="Ej: Disney+ o micorreo@gmail.com" autocomplete="off">
                    </div>

                    <div class="input-group-premium">
                        <label>DETALLES DEL PROBLEMA</label>
                        <textarea id="ticket-contexto" class="ticket-textarea" placeholder="Explícanos qué sucede o qué necesitas..."></textarea>
                    </div>

                    <button class="btn-submit-ticket" onclick="enviarTicketBD()">
                        ENVIAR REPORTE <span class="material-icons-round">send</span>
                    </button>
                </div>
            </div>
        </div>
    `;
}

/**
 * 2. LÓGICA DE ACORDEÓN PARA FAQ
 */
function toggleFAQ(element) {
    document.querySelectorAll('.faq-item').forEach(item => {
        if (item !== element) item.classList.remove('active');
    });
    element.classList.toggle('active');
}

/**
 * 3. LÓGICA DEL MODAL (SIN CARGA DE DATOS)
 */
function abrirModalTicket(tipo) {
    const modal = document.getElementById('ticket-modal-overlay');
    const inputTipo = document.getElementById('ticket-tipo');
    const inputCuenta = document.getElementById('ticket-cuenta-input');
    
    if (modal && inputTipo && inputCuenta) {
        // Reset de campos
        inputTipo.value = tipo;
        document.getElementById('ticket-contexto').value = "";
        inputCuenta.value = "";
        
        // Mostrar modal
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('show'), 10);
    }
}

function cerrarModalTicket() {
    const modal = document.getElementById('ticket-modal-overlay');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }
}

/**
 * 4. ENVÍO DEL TICKET Y ACTUALIZACIÓN DE CACHÉ LOCAL
 */
async function enviarTicketBD() {
    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');
    
    const tipo = document.getElementById('ticket-tipo').value;
    const cuentaSeleccionada = document.getElementById('ticket-cuenta-input').value.trim();
    const contextoRaw = document.getElementById('ticket-contexto').value.trim();

    if (!contextoRaw) {
        return Swal.fire({
            icon: 'warning', title: 'Faltan datos',
            text: 'Por favor explica brevemente tu problema en los detalles.',
            background: '#0a0a0a', color: '#fff'
        });
    }

    // Unimos la cuenta manual con el mensaje del usuario
    const contextoFinal = (cuentaSeleccionada && cuentaSeleccionada !== "") 
        ? `[Sobre: ${cuentaSeleccionada}] \n\nDetalle: ${contextoRaw}` 
        : contextoRaw;

    Swal.fire({ 
        title: 'ENVIANDO TICKET', 
        text: 'Registrando en el sistema de soporte...',
        didOpen: () => Swal.showLoading(), 
        background: '#0a0a0a', color:'#fff',
        allowOutsideClick: false,
        customClass: { container: 'swal-top-layer' }
    });

    try {
        const res = await apiCall({ 
            accion: 'crearTicket', 
            usuario: u, 
            token: t, 
            tipo: tipo, 
            contexto: contextoFinal 
        });

        if (res.success) {
            cerrarModalTicket();
            
            // --- INYECCIÓN EN CACHÉ DE MISTICKETS CON ID REAL ---
            
            // IMPORTANTE: Asegúrate de que tu Google Script devuelva "fila" en el JSON
            // Si el script no devuelve fila, usamos 0 (pero 0 dará error al cerrar si no se actualiza)
            const idFilaReal = res.fila ? res.fila : 0;

            const nuevoTicketVirtual = {
                tipo: tipo,
                fecha: new Date().toISOString(), // Fecha actual
                estado: 'Abierto',
                contexto: contextoFinal,
                respuesta: '',
                fila: idFilaReal // <--- AQUI GUARDAMOS LA FILA REAL QUE VINO DEL SERVER
            };

            const cacheKey = 'jeico_tickets_cache_v30min';
            let cachedData = { timestamp: Date.now(), datos: [] };
            const rawCache = localStorage.getItem(cacheKey);

            if (rawCache) {
                try {
                    cachedData = JSON.parse(rawCache);
                    if (!Array.isArray(cachedData.datos)) cachedData.datos = [];
                } catch (e) { }
            }

            // Agregamos al inicio
            cachedData.datos.unshift(nuevoTicketVirtual);
            
            // RESETEAMOS EL RELOJ DE 30 MINUTOS
            cachedData.timestamp = Date.now();

            // Guardamos
            localStorage.setItem(cacheKey, JSON.stringify(cachedData));
            // ----------------------------------------

            Swal.fire({
                icon: 'success',
                title: 'TICKET CREADO',
                text: 'En la mayor brevedad se te dará solución...',
                background: '#0a0a0a', 
                color: '#fff', 
                timer: 4000, 
                showConfirmButton: false
            });
            
        } else {
            Swal.fire({ icon: 'error', title: 'Error', text: res.msg, background: '#0a0a0a', color: '#fff' });
        }
    } catch (error) {
        Swal.fire({ icon: 'error', title: 'Falla de conexión', text: 'Revisa tu internet.', background: '#0a0a0a', color: '#fff' });
    }
}

/**
 * 5. ESTILOS DE SOPORTE PREMIUM (LIMPIOS)
 */
const soporteStyles = `
    .soporte-wrapper-premium {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .support-grid {
        display: grid;
        grid-template-columns: 1fr 1.2fr;
        gap: 40px;
        width: 100%;
        margin-top: 20px;
    }

    .support-contact-card {
        background: linear-gradient(145deg, #0a0a0a 0%, #050505 100%);
        border: 1px solid #1a1a1a;
        border-radius: 20px;
        padding: 40px 30px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        height: fit-content;
    }

    .support-card-header h3 { color: #fff; font-family: 'Righteous', cursive; letter-spacing: 1px; margin: 15px 0 10px 0; }
    .support-card-header p { color: #777; font-size: 0.85rem; line-height: 1.5; margin-bottom: 30px; }

    .support-action-buttons { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
    
    .btn-ticket {
        background: rgba(124, 58, 237, 0.1); border: 1px solid var(--accent); color: #fff;
        padding: 16px; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 10px;
        font-weight: 700; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
    }
    .btn-ticket:hover { background: var(--accent); box-shadow: 0 0 20px var(--accent-glow); transform: translateY(-3px); }
    .btn-ticket.outline { background: transparent; border: 1px solid #333; color: #aaa; }
    .btn-ticket.outline:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.05); box-shadow: none; }

    .warranty-info {
        display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--success);
        font-size: 0.75rem; background: rgba(5, 150, 105, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(5, 150, 105, 0.2);
    }

    /* ACORDEÓN FAQ */
    .faq-container { display: flex; flex-direction: column; gap: 15px; }
    .faq-title { color: #fff; font-family: 'Righteous', cursive; letter-spacing: 1px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #1a1a1a; }
    .faq-item { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.3s; }
    .faq-item:hover { border-color: #333; }
    .faq-item.active { border-color: var(--accent); background: rgba(124, 58, 237, 0.05); }
    .faq-question { padding: 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #e5e5e5; font-size: 0.95rem; }
    .faq-question .arrow { transition: transform 0.4s ease; color: var(--accent); }
    .faq-item.active .faq-question .arrow { transform: rotate(180deg); }
    .faq-answer { max-height: 0; padding: 0 20px; opacity: 0; color: #888; font-size: 0.85rem; line-height: 1.6; transition: all 0.4s ease; }
    .faq-item.active .faq-answer { max-height: 200px; padding: 0 20px 20px 20px; opacity: 1; }

    /* =========================================
       DISEÑO MODAL DE TICKET
       ========================================= */
    .ticket-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
        z-index: 9999; display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
    }
    .ticket-overlay.show { opacity: 1; pointer-events: auto; }
    
    .ticket-modal-content {
        background: #050505; border: 1px solid #1a1a1a; border-radius: 16px;
        width: 90%; max-width: 450px; overflow: visible;
        transform: translateY(20px); transition: transform 0.3s ease;
        box-shadow: 0 20px 50px rgba(0,0,0,0.9), 0 0 30px rgba(124, 58, 237, 0.15);
    }
    .ticket-overlay.show .ticket-modal-content { transform: translateY(0); }

    .ticket-modal-header {
        background: var(--accent); padding: 20px; display: flex;
        justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0;
    }
    .ticket-modal-header h2 { color: #fff; font-size: 1.1rem; letter-spacing: 2px; margin: 0; }
    .btn-close-ticket { background: none; border: none; color: #fff; cursor: pointer; display: flex; }

    .ticket-modal-body { padding: 30px 25px; }
    .ticket-help-text { color: #777; font-size: 0.8rem; margin-bottom: 25px; text-align: center; }

    .input-group-premium { margin-bottom: 20px; display: flex; flex-direction: column; gap: 8px; }
    .input-group-premium label { color: var(--accent); font-size: 0.7rem; font-weight: 800; letter-spacing: 1px; }
    
    .ticket-input, .ticket-textarea {
        background: #0a0a0a; border: 1px solid #222; border-radius: 8px;
        padding: 12px 15px; color: #fff; font-family: 'Inter', sans-serif;
        font-size: 0.9rem; outline: none; transition: 0.3s; width: 100%;
    }
    .ticket-input:focus, .ticket-textarea:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(124,58,237,0.2); }
    .ticket-input.readonly { color: #888; background: #000; cursor: not-allowed; font-weight: bold;}
    
    .ticket-textarea { height: 100px; resize: none; }

    .btn-submit-ticket {
        width: 100%; background: var(--success); color: #fff; border: none;
        padding: 16px; border-radius: 8px; font-weight: 800; letter-spacing: 1px;
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        gap: 10px; transition: 0.3s; margin-top: 10px;
    }
    .btn-submit-ticket:hover { background: #047857; transform: scale(1.02); }

    @media (max-width: 768px) { .support-grid { grid-template-columns: 1fr; gap: 30px; } }
`;

const styleSheetSoporte = document.createElement("style");
styleSheetSoporte.innerText = soporteStyles;
document.head.appendChild(styleSheetSoporte);</script>
<script id="script-codigo.js">/* codigo.js */
/**
 * ===============================================================
 * CODIGOS.JS - PORTAL DE ACCESO SEGURO (MANUAL / SIN AUTOCOMPLETE)
 * ===============================================================
 */

// ============================================================
// CONFIGURACIÓN DE ENDPOINTS
// ============================================================
const URL_MAESTRO = "https://script.google.com/macros/s/AKfycbyZu-05L75tVwAvJjN7gQ7JQZ7EyxgEUhT723Jd9tXHjdAvZaVXGE6AsENiwyyQX_ukwQ/exec";
const LISTA_OBREROS = [
    "https://script.google.com/macros/s/AKfycbxRf-m0Z3xjDwRrps5Ia3zdGZtWKioxPj3h3nrexlCzOawt7fzdFgeC_xeqj-zsCJzCrA/exec",
    "https://script.google.com/macros/s/AKfycbyHVbLbV2jhNYPDyxjmp9yIKO9HWAl3IxvO1qAuvMRlVZdFUCGD88U6OsJw8mnpSS3X/exec",
    "https://script.google.com/macros/s/AKfycbyD_7GCUkn2t5O7kl95mU7riGMOiy0hNJtPduv6Sf_37mxfSm50OnMn4aRWlsl7wN7e/exec",
    "https://script.google.com/macros/s/AKfycbxUuHwtfFTW2bnOUBHkw3TkVVoQi9hH4Kk_y96T6XIC6VMwl9qeZmZZckmoySgZnXil/exec",
    "https://script.google.com/macros/s/AKfycbw-V7SRUufYl5hkAWcLV8ajQbCa0vzTD3iwklRas2_ddY4YAzzVAE59XgdeVmLmUrBRDQ/exec"
];

const COOLDOWN_CODIGOS = 20; // Segundos
let enCooldownCodigos = false;

/**
 * 1. FUNCIÓN PRINCIPAL DE CARGA DE LA VISTA
 */
function cargarCodigos() {
    const container = document.getElementById('sec-codigos');
    if (!container) return;

    // Se eliminó la lista UL y los eventos oninput/onclick del input de correo
    container.innerHTML = `
        <div class="codigos-wrapper-premium">
            <div class="page-header-premium" style="text-align: center; margin-bottom: 30px;">
                <h1 class="page-title">PORTAL DE <span>CÓDIGOS</span></h1>
                <p class="page-subtitle">Obtén tu acceso de 6 dígitos o enlace de restablecimiento al instante.</p>
            </div>

            <div class="card-codigos">
                <div id="formAccesoCodigos">
                    
                    <div class="input-group-premium" style="position: relative; margin-bottom: 20px;">
                        <label>Correo de la Cuenta</label>
                        <div class="input-wrapper">
                            <span class="material-icons-round input-icon">email</span>
                            <input type="email" id="txtUserCod" class="ticket-input" placeholder="ejemplo@gmail.com" autocomplete="off">
                        </div>
                    </div>

                    <div class="input-group-premium" style="margin-bottom: 20px;">
                        <label>Contraseña de Acceso</label>
                        <div class="input-wrapper">
                            <span class="material-icons-round input-icon">lock</span>
                            <input type="password" id="txtPassCod" class="ticket-input" placeholder="••••••••">
                            <span class="material-icons-round toggle-password" id="togglePassCod" onclick="togglePasswordVisibilidad()">visibility</span>
                        </div>
                    </div>

                    <div class="input-group-premium">
                        <label>Selecciona el Servicio</label>
                        <div class="services-grid">
                            <button type="button" class="btn-service-brand active" data-asunto="Tu código de acceso único para Disney+" data-brand="Disney">
                                <span class="brand-icon">D+</span> Disney+
                            </button>
                            <button type="button" class="btn-service-brand" data-asunto="Urgente: Tu código de un solo uso||Tu enlace para restablecer tu contraseña requerido" data-brand="HBO">
                                <span class="brand-icon">H+</span> HBO+
                            </button>
                            <button type="button" class="btn-service-brand" data-asunto="Verificación de Amazon" data-brand="Amazon">
                                <span class="brand-icon">AMZ</span> Amazon
                            </button>
                            <button type="button" class="btn-service-brand" data-asunto="Reset Your Crunchyroll Password||Restablece tu contraseña de Crunchyroll" data-brand="Crunchyroll">
                                <span class="brand-icon">CR</span> Crunchy
                            </button>
                        </div>
                        <input type="hidden" id="txtAsuntoCod" value="Tu código de acceso único para Disney+">
                    </div>

                    <button id="btnVerificarCod" class="btn-submit-ticket" onclick="ejecutarAccesoCodigos()" style="margin-top: 25px;">
                        <span class="material-icons-round" id="btnIconCod">smart_toy</span>
                        <span id="btnTextCod">OBTENER CÓDIGO</span>
                    </button>
                </div>

                <div id="statusAreaCod" class="status-msg-cod info-cod hidden" style="margin-top:20px;">
                    <span class="material-icons-round icon-status">terminal</span>
                    <span id="statusTextCod">Sistema listo.</span>
                </div>

                <div id="resultadoFinalCod" class="result-container-cod hidden">
                    <div class="result-label" id="resultLabelCod">CÓDIGO DE VERIFICACIÓN</div>
                    <div id="codigoGrande" class="code-display">000000</div>
                    <div id="fechaMsgCod" class="fecha-msg"></div>
                </div>

                <div id="fallbackAreaCod" class="fallback-msg hidden" style="margin-top:20px;">
                    <p>¿No llega el código? <br><span style="font-size:13px; color:#aaa;">Es posible que debas solicitarlo nuevamente en la plataforma original.</span></p>
                    <a id="btnSolicitarManualCod" href="#" target="_blank" class="btn-manual-request">
                        Solicita el código manualmente <span class="material-icons-round" style="font-size:14px;">open_in_new</span>
                    </a>
                </div>
            </div>
        </div>
    `;

    // Inicializar lógica de la vista (Botones de servicio)
    initServiceButtonsCodigos();
    
    // NOTA: Se ha eliminado la llamada a cargarCuentasParaAutocomplete()
    // y los EventListeners del dropdown.

    // Enter para ejecutar
    document.getElementById("txtPassCod").addEventListener("keydown", e => {
        if (e.key === "Enter") ejecutarAccesoCodigos();
    });
}

/**
 * 2. LÓGICA DE INTERFAZ (BOTONES, TOGGLE PASS)
 */
function togglePasswordVisibilidad() {
    const passInput = document.getElementById("txtPassCod");
    const toggleIcon = document.getElementById("togglePassCod");
    
    if (passInput.type === "password") {
        passInput.type = "text";
        toggleIcon.innerText = "visibility_off";
        toggleIcon.style.color = "var(--success)";
    } else {
        passInput.type = "password";
        toggleIcon.innerText = "visibility";
        toggleIcon.style.color = "var(--accent)";
    }
}

function initServiceButtonsCodigos() {
    const botones = document.querySelectorAll(".btn-service-brand");
    const inputAsunto = document.getElementById("txtAsuntoCod");
    const btnVerificar = document.getElementById("btnVerificarCod");
    const btnText = document.getElementById("btnTextCod");
    
    botones.forEach(boton => {
        boton.addEventListener("click", () => {
            if(boton.disabled) return;

            botones.forEach(b => b.classList.remove("active"));
            boton.classList.add("active");
            
            const asuntoSeleccionado = boton.getAttribute("data-asunto");
            const brand = boton.getAttribute("data-brand");
            inputAsunto.value = asuntoSeleccionado;

            // LÓGICA DE BLOQUEO (AMAZON)
            if (brand === "Amazon") {
                btnVerificar.disabled = true;
                btnText.innerText = "Próximamente";
                
                Swal.fire({
                    toast: true, position: 'top-end', icon: 'info',
                    title: 'Servicio en Mantenimiento',
                    text: 'Amazon estará disponible pronto.',
                    showConfirmButton: false, timer: 3000,
                    background: '#0a0a0a', color: '#ff9900'
                });
            } else {
                if (!enCooldownCodigos) {
                    btnVerificar.disabled = false;
                    btnText.innerText = "OBTENER CÓDIGO";
                }
            }
        });
    });
}

/**
 * 3. NÚCLEO DE EXTRACCIÓN Y API
 */
async function faseIA(texto, icono, delay = 700) {
    const status = document.getElementById("statusAreaCod");
    const textEl = document.getElementById("statusTextCod");
    const iconEl = status.querySelector(".icon-status");
    
    status.classList.remove('hidden', 'error', 'success');
    status.classList.add('info-cod');
    
    iconEl.innerText = icono;
    textEl.innerHTML = texto;
    
    await new Promise(resolve => setTimeout(resolve, delay));
}

function iniciarCooldownCodigos() {
    enCooldownCodigos = true;
    let restante = COOLDOWN_CODIGOS;
    const btn = document.getElementById("btnVerificarCod");
    const txtBtn = document.getElementById("btnTextCod");
    const iconBtn = document.getElementById("btnIconCod");

    btn.disabled = true;

    const timer = setInterval(() => {
        restante--;
        txtBtn.innerText = `ESPERA ${restante}s`;

        if (restante <= 0) {
            clearInterval(timer);
            enCooldownCodigos = false;
            btn.disabled = false;
            txtBtn.innerText = "OBTENER CÓDIGO";
            if(iconBtn) iconBtn.innerText = "smart_toy";
        }
    }, 1000);
}

async function ejecutarAccesoCodigos() {
    if (enCooldownCodigos) return;

    const user = document.getElementById("txtUserCod").value.trim();
    const pass = document.getElementById("txtPassCod").value.trim();
    const asunto = document.getElementById("txtAsuntoCod").value.trim(); 
    
    const botonActivo = document.querySelector(".btn-service-brand.active");
    const nombreServicioCorto = botonActivo ? botonActivo.getAttribute("data-brand") : "";
    
    const btn = document.getElementById("btnVerificarCod");
    const txtBtn = document.getElementById("btnTextCod");
    const iconBtn = document.getElementById("btnIconCod");
    const status = document.getElementById("statusAreaCod");
    const textEl = document.getElementById("statusTextCod");
    const resBox = document.getElementById("resultadoFinalCod");
    const codigoGrande = document.getElementById("codigoGrande");
    const fechaMsg = document.getElementById("fechaMsgCod");
    const fallbackArea = document.getElementById("fallbackAreaCod"); 
    const btnManual = document.getElementById("btnSolicitarManualCod"); 
    const resultLabel = document.getElementById("resultLabelCod"); 

    if (!user || !pass) {
        Swal.fire({ icon: 'error', title: 'Faltan datos', text: 'Ingresa correo y contraseña.', background: '#0a0a0a', color: '#fff' });
        return;
    }

    // Reset visual
    btn.disabled = true;
    txtBtn.innerText = "PROCESANDO...";
    iconBtn.innerText = "sync";
    iconBtn.classList.add("fa-spin"); 
    resBox.classList.add("hidden");
    fallbackArea.classList.add("hidden"); 

    try {
        await faseIA("Inicializando motor de búsqueda...", "memory");
        await faseIA("Validando credenciales en la Bóveda...", "security");

        // 1. LOGIN MAESTRO
        const login = await fetch(`${URL_MAESTRO}?usuario=${encodeURIComponent(user)}&clave=${encodeURIComponent(pass)}&servicio=${encodeURIComponent(nombreServicioCorto)}`);
        const dataM = await login.json();

        if (!dataM.exito) {
            throw new Error(dataM.mensaje || "Credenciales inválidas.");
        }

        await faseIA("Acceso autorizado. Conectando servidores...", "public");
        await faseIA("Analizando bandeja de entrada...", "psychology");

        let codigoFinal = "";
        let infoExito = null;

        // 2. BÚSQUEDA EN WORKERS
        for (let i = 0; i < LISTA_OBREROS.length; i++) {
            try {
                const r = await fetch(`${LISTA_OBREROS[i]}?usuario=${encodeURIComponent(user)}&asunto=${encodeURIComponent(asunto)}`);
                const d = await r.json();

                if (d.exito && d.encontrado) {
                    codigoFinal = extraerDatosCorreo(asunto, d.cuerpo);
                    if (codigoFinal) {
                        infoExito = d;
                        break;
                    }
                }
            } catch { /* Silencio en errores de red del worker */ }
        }

        if (!codigoFinal) throw new Error("NOT_FOUND");
        
        // 3. RENDERIZADO DEL RESULTADO
        if (codigoFinal.startsWith("http")) {
            resultLabel.innerText = "ENLACE DE RECUPERACIÓN";
            codigoGrande.innerHTML = `<a href="${codigoFinal}" target="_blank" class="btn-link-neon"><span class="material-icons-round" style="font-size:18px;">open_in_new</span> RESTABLECE<br>TU CLAVE AQUÍ</a>`;
            codigoGrande.style.fontSize = "16px"; 
            codigoGrande.style.letterSpacing = "normal";
        } else {
            resultLabel.innerText = "CÓDIGO DE VERIFICACIÓN";
            codigoGrande.innerText = codigoFinal;
            codigoGrande.style.fontSize = "48px";
            codigoGrande.style.letterSpacing = "6px";
        }

        // Registro pasivo (Opcional)
        fetch(`${URL_MAESTRO}?accion=registrar_codigo&usuario=${encodeURIComponent(user)}&codigo_encontrado=${encodeURIComponent(codigoFinal.substring(0,50))}`, { mode: "no-cors" });

        fechaMsg.innerHTML = `<span class="material-icons-round" style="font-size:14px;">schedule</span> Recibido a las: ${infoExito.hora || "Reciente"}`;
        resBox.classList.remove("hidden");

        status.className = "status-msg-cod success";
        status.querySelector(".icon-status").innerText = "check_circle";
        textEl.innerText = "Proceso finalizado. Información recuperada.";

        // Éxito
        iconBtn.classList.remove("fa-spin");
        iniciarCooldownCodigos();

    } catch (err) {
        status.className = "status-msg-cod error";
        status.querySelector(".icon-status").innerText = "error";
        
        if (err.message === "Cuenta sin ese servicio") {
            textEl.innerHTML = "No tienes este servicio contratado.<br>Contacta a soporte si crees que es un error.";
        }
        else if (err.message === "NOT_FOUND" || err.message.includes("No se encontró")) {
            textEl.innerText = "No se encontró información reciente.";
            
            let linkManual = "#";
            if (asunto.includes("Disney")) linkManual = "https://www.disneyplus.com/identity/login/enter-passcode";
            else if (asunto.includes("Crunchyroll") || asunto.includes("Reset")) linkManual = "https://sso.crunchyroll.com/es/reset-password";
            else if (asunto.includes("HBO") || asunto.includes("Urgente") || asunto.includes("restablecer")) linkManual = "https://auth.hbomax.com/login"; 
            
            if (btnManual) {
                btnManual.href = linkManual;
                fallbackArea.classList.remove("hidden");
            }
        } else {
            textEl.innerText = err.message;
        }

        btn.disabled = false;
        txtBtn.innerText = "INTENTAR DE NUEVO";
        iconBtn.classList.remove("fa-spin");
        iconBtn.innerText = "refresh";
    }
}

/**
 * 4. MOTOR DE EXTRACCIÓN DE TEXTO
 */
function extraerDatosCorreo(asunto, cuerpoOriginal) {
    let codigoFinal = null;
    let match = null;
    const textoAplanado = cuerpoOriginal.replace(/\s+/g, " ");

    if (asunto.includes("HBO") || asunto.includes("Urgente") || asunto.includes("restablecer")) {
        const matchCode = textoAplanado.match(/un\s+solo\s+uso.*?(\d{6})/i);
        if (matchCode) return matchCode[1];

        let textoLink = textoAplanado;
        const frase = "RESTABLECER CONTRASEÑA";
        let textoMayusculas = textoLink.toUpperCase();
        
        let idx1 = textoMayusculas.indexOf(frase);
        if (idx1 !== -1) {
            textoLink = textoLink.substring(idx1);
            textoMayusculas = textoLink.toUpperCase(); 
            
            let idx2 = textoMayusculas.indexOf(frase, frase.length);
            if (idx2 !== -1) {
                textoLink = textoLink.substring(0, idx2);
                textoLink = textoLink.replace(/RESTABLECER\s+CONTRASE.A/ig, "");
                textoLink = textoLink.replace(/[()]/g, "");
                textoLink = textoLink.replace(/\s+/g, "");
                
                if (textoLink.startsWith("http")) codigoFinal = textoLink;
            }
        }
    }
    else if (asunto.includes("Crunchyroll")) {
        const regexCrunchy = /https:\/\/links\.mail\.crunchyroll\.com\/ls\/click[^>"\s]+/g;
        const linksCrunchy = textoAplanado.match(regexCrunchy);
        if (linksCrunchy) {
            codigoFinal = (linksCrunchy.length >= 2 ? linksCrunchy[1] : linksCrunchy[0]).replace(/\s/g, "");
        }
    }
    else if (asunto.includes("Disney+")) {
        match = textoAplanado.match(/(\d{6})\s*Si\s+no\s+lo\s+solicitaste/i) || textoAplanado.match(/\b(\d{6})\b/);
        if (match) codigoFinal = match[1];
    }
    
    if (!codigoFinal) {
        match = textoAplanado.match(/\b(\d{6})\b/);
        if (match) codigoFinal = match[1];
    }

    return codigoFinal;
}

/**
 * 5. ESTILOS INTEGRADOS (GOTH PREMIUM + BRAND COLORS)
 */
const codigosStyles = `
    .codigos-wrapper-premium {
        max-width: 500px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .card-codigos {
        background: linear-gradient(145deg, #0a0a0a 0%, #050505 100%);
        border: 1px solid #1a1a1a;
        padding: 40px 30px;
        border-radius: 24px;
        width: 100%;
        box-shadow: 0 20px 50px rgba(0,0,0,0.8), 0 0 20px rgba(124, 58, 237, 0.1);
    }

    .page-title span { color: var(--accent); text-shadow: 0 0 15px var(--accent-glow); }

    /* INPUTS */
    .input-wrapper { position: relative; display: flex; align-items: center; }
    .input-icon { position: absolute; left: 15px; color: var(--accent); font-size: 20px; }
    .toggle-password { position: absolute; right: 15px; cursor: pointer; color: var(--accent); font-size: 20px; transition: 0.3s; }
    .toggle-password:hover { color: var(--success); transform: scale(1.1); }
    
    #txtUserCod, #txtPassCod {
        padding-left: 45px; padding-right: 45px;
    }

    /* GRID DE MARCAS */
    .services-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 5px;
    }

    .btn-service-brand {
        background: rgba(255,255,255,0.03);
        border: 1px solid #222;
        color: #aaa;
        padding: 15px 10px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        transition: 0.3s;
    }

    .brand-icon { font-size: 1.2rem; font-family: 'Righteous', cursive; }

    /* Colores por Marca */
    .btn-service-brand[data-brand="Disney"]:hover:not(:disabled) { border-color: #006aff; color: #fff; background: rgba(0,106,255,0.1); }
    .btn-service-brand[data-brand="Disney"].active { background: #006aff; color: #fff; border-color: #006aff; box-shadow: 0 0 15px rgba(0,106,255,0.4); }

    .btn-service-brand[data-brand="HBO"]:hover:not(:disabled) { border-color: #7e00e6; color: #fff; background: rgba(126,0,230,0.1); }
    .btn-service-brand[data-brand="HBO"].active { background: #7e00e6; color: #fff; border-color: #7e00e6; box-shadow: 0 0 15px rgba(126,0,230,0.4); }

    .btn-service-brand[data-brand="Amazon"]:hover:not(:disabled) { border-color: #ff9900; color: #fff; background: rgba(255,153,0,0.1); }
    .btn-service-brand[data-brand="Amazon"].active { background: #ff9900; color: #000; border-color: #ff9900; box-shadow: 0 0 15px rgba(255,153,0,0.4); }

    .btn-service-brand[data-brand="Crunchyroll"]:hover:not(:disabled) { border-color: #f47521; color: #fff; background: rgba(244,117,33,0.1); }
    .btn-service-brand[data-brand="Crunchyroll"].active { background: #f47521; color: #000; border-color: #f47521; box-shadow: 0 0 15px rgba(244,117,33,0.4); }

    /* STATUS Y RESULTADOS */
    .status-msg-cod {
        display: flex; align-items: center; justify-content: center; gap: 10px;
        padding: 15px; border-radius: 12px; font-size: 0.85rem; font-weight: 700;
        text-align: center; line-height: 1.4;
    }
    .status-msg-cod.info-cod { background: rgba(124, 58, 237, 0.1); border: 1px solid var(--accent); color: #fff; }
    .status-msg-cod.error { background: rgba(255, 0, 85, 0.1); border: 1px solid #ff0055; color: #ff4d88; }
    .status-msg-cod.success { background: rgba(0, 255, 136, 0.1); border: 1px solid var(--success); color: var(--success); }

    .result-container-cod {
        margin-top: 20px; background: #000; border: 2px solid var(--success);
        border-radius: 16px; padding: 25px; text-align: center; box-shadow: 0 0 20px rgba(0,255,136,0.1);
    }
    .result-label { font-size: 0.7rem; color: var(--success); font-weight: 800; letter-spacing: 2px; margin-bottom: 10px; }
    .code-display { font-family: 'monospace'; color: var(--success); text-shadow: 0 0 15px rgba(0,255,136,0.5); word-break: break-all; }
    .fecha-msg { margin-top: 15px; font-size: 0.75rem; color: #888; display: flex; align-items: center; justify-content: center; gap: 5px; }

    /* ENLACES Y BOTONES */
    .btn-link-neon {
        display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        background: var(--success); color: #000; padding: 12px 20px; border-radius: 50px;
        font-weight: 800; text-decoration: none; margin-top: 10px; transition: 0.3s;
    }
    .btn-link-neon:hover { background: #fff; transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,136,0.6); }

    .fallback-msg { text-align: center; }
    .btn-manual-request {
        display: inline-flex; align-items: center; justify-content: center; gap: 5px;
        margin-top: 10px; padding: 10px 20px; background: #111; color: #fff;
        text-decoration: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600;
        border: 1px solid #333; transition: 0.3s;
    }
    .btn-manual-request:hover { background: #222; border-color: var(--accent); color: var(--accent); }

    .fa-spin { animation: spin 1s infinite linear; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
`;

const styleSheetCodigos = document.createElement("style");
styleSheetCodigos.innerText = codigosStyles;
document.head.appendChild(styleSheetCodigos);</script>
<script id="script-mistickets.js">/* mistickets.js */
/**
 * ===============================================================
 * MISTICKETS.JS - SISTEMA OPTIMIZADO (CACHE 30 MIN - SINCRONIZABLE)
 * ===============================================================
 */

let cargandoTickets = false;
// CONFIGURACIÓN: 30 Minutos de validez para el caché de lectura
const TIEMPO_VALIDEZ_CACHE_TICKETS = 30 * 60 * 1000; 

/**
 * 1. FUNCIÓN PRINCIPAL: Obtener y renderizar los tickets
 * @param {boolean} forzarRecarga - Si es true, ignora el caché y pide datos nuevos.
 */
async function cargarMisTickets(forzarRecarga = false) {
    if (cargandoTickets) return;
    cargandoTickets = true;

    const container = document.getElementById('tickets-container');
    if (!container) {
        cargandoTickets = false;
        return;
    }
    
    // CREDENCIALES
    const u = localStorage.getItem('jeico_user');
    const t = localStorage.getItem('jeico_token');

    if (!u || !t) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align:center; padding:40px;">
                <span class="material-icons-round" style="font-size:3rem; color:var(--danger);">error_outline</span>
                <p style="color: var(--danger); font-weight: bold; margin-top: 15px;">Error: No se detecta una sesión activa.</p>
            </div>`;
        cargandoTickets = false;
        return;
    }

    // --- LÓGICA DE CACHÉ DE 30 MINUTOS ---
    const cacheRaw = localStorage.getItem('jeico_tickets_cache_v30min'); 
    
    if (cacheRaw && !forzarRecarga) {
        try {
            const cache = JSON.parse(cacheRaw);
            const edadCache = Date.now() - cache.timestamp;

            // SI LA CACHÉ TIENE MENOS DE 30 MINUTOS, LA USAMOS Y PARAMOS.
            if (edadCache < TIEMPO_VALIDEZ_CACHE_TICKETS) {
                console.log(`♻️ Usando caché local de tickets (Edad: ${Math.round(edadCache/60000)} min).`);
                
                renderMisTickets(cache.datos);
                
                cargandoTickets = false;
                return; // <--- ESCUDO DE ENFRIAMIENTO ACTIVO
            }
        } catch (e) {
            console.warn("Error leyendo caché de tickets, se procederá a descargar de nuevo.");
        }
    }

    // Solo mostramos spinner si el contenedor está vacío para evitar parpadeos feos
    if (!container.querySelector('.ticket-card-premium')) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align:center; padding:60px;">
                <div class="spinner"></div>
                <p style="color:var(--text-gray); margin-top:20px; letter-spacing:2px; font-size:0.8rem;">Conectando con soporte...</p>
            </div>
        `;
    }

    try {
        console.log("📡 Sincronizando historial de tickets con el servidor...");
        // Llamada al backend
        const res = await apiCall({ 
            accion: 'getMisTickets', 
            usuario: u, 
            token: t 
        });

        if (res && res.success) {
            // Guardamos datos + TIMESTAMP actual para la próxima vez (Activa los 30 min de enfriamiento)
            const objetoCache = {
                timestamp: Date.now(),
                datos: res.datos
            };
            localStorage.setItem('jeico_tickets_cache_v30min', JSON.stringify(objetoCache));
            
            // Renderizamos los datos frescos
            renderMisTickets(res.datos);
        } else {
            // Si falla y no hay nada mostrado, mostramos error
            if (!container.querySelector('.ticket-card-premium')) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align:center; padding:40px;">
                        <span class="material-icons-round" style="font-size:3rem; color:var(--danger);">dns</span>
                        <p style="color: var(--danger); font-weight: bold; margin-top: 15px;">Error del servidor: ${res ? res.msg : 'Respuesta vacía'}</p>
                        <button onclick="cargarMisTickets(true)" class="btn-retry" style="margin-top:10px; padding:8px 15px; border-radius:5px; border:1px solid #333; background:transparent; color:#fff; cursor:pointer;">Reintentar</button>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error("Error crítico en Mis Tickets:", error);
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align:center; padding:40px;">
                <span class="material-icons-round" style="font-size:3rem; color:var(--danger);">wifi_off</span>
                <p style="color: var(--danger); font-weight: bold; margin-top: 15px;">Fallo en la conexión</p>
                <button onclick="cargarMisTickets(true)" class="btn-retry" style="margin-top:10px; padding:8px 15px; border-radius:5px; border:1px solid #333; background:transparent; color:#fff; cursor:pointer;">Reintentar</button>
            </div>
        `;
    } finally {
        cargandoTickets = false;
    }
}

/**
 * 2. RENDERIZADO: Construir el HTML de los tickets
 */
function renderMisTickets(tickets) {
    const container = document.getElementById('tickets-container');
    if (!container) return;
    
    try {
        container.innerHTML = ""; 

        if (!tickets || tickets.length === 0) {
            container.innerHTML = `
                <div class="no-orders-container" style="grid-column: 1/-1; text-align: center; padding: 80px 20px; border: 1px dashed #1a1a1a; border-radius: 20px; background: rgba(0,0,0,0.2);">
                    <span class="material-icons-round" style="font-size: 4rem; color: #333; margin-bottom: 15px;">gpp_good</span>
                    <p style="color: #888; font-weight: 800; letter-spacing: 2px; text-transform: uppercase;">Sin Incidencias</p>
                    <small style="color: #555;">No hay reportes activos en tu historial.</small>
                </div>
            `;
            return;
        }

        tickets.forEach(ticket => {
            const estadoSeguro = String(ticket.estado || "Abierto").trim();
            const esAbierto = estadoSeguro.toLowerCase() === 'abierto';
            
            // Colores más vibrantes para el estado
            const colorEstado = esAbierto ? '#ff9900' : '#10b981'; 
            const bgEstado = esAbierto ? 'rgba(255, 153, 0, 0.1)' : 'rgba(16, 185, 129, 0.1)';
            const iconEstado = esAbierto ? 'hourglass_empty' : 'check_circle';
            
            let fechaStr = "Fecha no disponible";
            if (ticket.fecha) {
                const fechaObj = new Date(ticket.fecha);
                fechaStr = fechaObj.toLocaleDateString() + ' - ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            let mensajeEstadoFooter = "";
            
            if (esAbierto) {
                mensajeEstadoFooter = `
                    <div class="ticket-closed-badge" style="color: #ff9900;">
                        <span class="material-icons-round" style="font-size:16px;">support_agent</span> EN REVISIÓN
                    </div>`;
            } else {
                mensajeEstadoFooter = `
                    <div class="ticket-closed-badge" style="color: #10b981;">
                        <span class="material-icons-round" style="font-size:16px;">lock</span> SOLUCIONADO
                    </div>`;
            }

            // Codificamos los textos de forma segura
            const textoCodificado = encodeURIComponent((ticket.contexto || 'Sin detalles.').replace(/'/g, "%27"));
            const respCodificada = encodeURIComponent((ticket.respuesta || '').replace(/'/g, "%27"));

            const card = document.createElement('div');
            card.className = 'ticket-card-premium'; 
            
            card.innerHTML = `
                <div class="ticket-header">
                    <div>
                        <div class="ticket-service-name">${ticket.tipo || 'Reporte de Soporte'}</div>
                        <div class="ticket-date">${fechaStr}</div>
                    </div>
                    <div class="ticket-status-pill" style="background: ${bgEstado}; border-color: ${colorEstado}40;">
                        <span class="material-icons-round" style="color: ${colorEstado};">${iconEstado}</span>
                        <span style="color: ${colorEstado};">${estadoSeguro}</span>
                    </div>
                </div>
                
                <div class="ticket-body">
                    <div class="ticket-detail-btn" onclick="mostrarDetalleModal('${textoCodificado}', '${respCodificada}')">
                        <div class="ticket-detail-label">
                            <span class="material-icons-round">visibility</span> 
                            <span>LEER REPORTE Y RESPUESTA</span>
                        </div>
                        <span class="material-icons-round detail-icon">open_in_new</span>
                    </div>
                </div>

                <div class="ticket-footer">
                    ${mensajeEstadoFooter}
                </div>
            `;
            container.appendChild(card);
        });

    } catch (renderError) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align:center; padding:40px;">
                <p style="color: var(--danger); font-weight: bold;">Error dibujando tickets: ${renderError.message}</p>
            </div>
        `;
    }
}

/**
 * 3. LÓGICA DE INTERFAZ: Modal para leer el reporte Y LA RESPUESTA
 */
window.mostrarDetalleModal = function(textoCodificado, respCodificada) {
    // Decodificamos y limpiamos
    const textoLimpio = decodeURIComponent(textoCodificado).replace(/%27/g, "'").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    const textoRespuesta = decodeURIComponent(respCodificada).replace(/%27/g, "'").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    let htmlModal = `
        <div class="modal-ticket-section client-msg">
            <div class="modal-ticket-title">
                <span class="material-icons-round">person</span> TU REPORTE:
            </div>
            <div class="modal-ticket-text">${textoLimpio}</div>
        </div>
    `;

    // Si el administrador ha dejado una respuesta
    if (textoRespuesta.trim() !== "") {
        htmlModal += `
            <div class="modal-ticket-section admin-msg">
                <div class="modal-ticket-title">
                    <span class="material-icons-round">support_agent</span> RESPUESTA DE SOPORTE:
                </div>
                <div class="modal-ticket-text">${textoRespuesta}</div>
            </div>
        `;
    } else {
        htmlModal += `
            <div class="modal-ticket-section admin-msg" style="opacity: 0.7;">
                <div class="modal-ticket-title" style="color: #ff9900;">
                    <span class="material-icons-round">hourglass_empty</span> EN ESPERA:
                </div>
                <div class="modal-ticket-text" style="color: #aaa; font-style: italic;">Tu ticket está siendo revisado por nuestro equipo. Te responderemos por este medio.</div>
            </div>
        `;
    }

    Swal.fire({
        title: 'Detalle del Ticket',
        html: htmlModal,
        background: '#0a0a0a',
        color: '#fff',
        confirmButtonColor: 'var(--accent)', 
        confirmButtonText: 'CERRAR',
        customClass: {
            popup: 'modal-ticket-premium'
        }
    });
};

/**
 * ===============================================================
 * ESTILOS CSS INYECTADOS VÍA JS (DISEÑO PREMIUM GOTH)
 * ===============================================================
 */

const ticketStyles = `
    .ticket-card-premium {
        background: #0d0d0d;
        border: 1px solid #1a1a1a;
        border-radius: 16px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 220px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .ticket-card-premium:hover {
        border-color: #333;
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(124, 58, 237, 0.08);
    }

    .ticket-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid #1a1a1a;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }

    .ticket-service-name {
        font-size: 1.1rem;
        color: #fff;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .ticket-date {
        font-size: 0.75rem;
        color: #666;
        margin-top: 6px;
        font-family: monospace;
    }

    .ticket-status-pill {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        border: 1px solid transparent;
    }
    
    .ticket-status-pill span:first-child { font-size: 1rem; }
    .ticket-status-pill span:last-child { font-size: 0.75rem; font-weight: 800; letter-spacing: 1px; }

    .ticket-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }

    .ticket-detail-btn {
        background: #111;
        border: 1px solid #222;
        border-radius: 10px;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    .ticket-detail-btn:hover { background: rgba(124, 58, 237, 0.1); border-color: rgba(124, 58, 237, 0.4); }

    .ticket-detail-label { display: flex; align-items: center; gap: 8px; color: #ccc; font-size: 0.75rem; font-weight: 700; letter-spacing: 1px; }

    .ticket-detail-btn:hover .ticket-detail-label, .ticket-detail-btn:hover .detail-icon { color: var(--accent, #7c3aed); }

    .detail-icon { color: #555; font-size: 1.2rem; transition: color 0.2s; }

    .ticket-footer { margin-top: 20px; display: flex; justify-content: flex-end; align-items: center; }

    .ticket-closed-badge {
        font-size: 0.8rem;
        font-weight: 800;
        letter-spacing: 2px;
        display: flex;
        align-items: center;
        gap: 6px;
        background: transparent;
        padding: 5px 0;
    }
    
    .ticket-closed-badge span { font-size: 1.1rem; }

    .modal-ticket-premium { border: 1px solid #222; border-radius: 16px !important; box-shadow: 0 20px 50px rgba(0,0,0,0.5) !important; }

    .modal-ticket-section { text-align: left; padding: 18px; border-radius: 12px; margin-bottom: 15px; }

    .modal-ticket-title { display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 0.8rem; letter-spacing: 1.5px; margin-bottom: 10px; }

    .modal-ticket-text { font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; max-height: 30vh; overflow-y: auto; }

    .client-msg { background: #050505; border: 1px solid #1a1a1a; }
    .client-msg .modal-ticket-title { color: var(--accent, #7c3aed); }
    .client-msg .modal-ticket-text { color: #ccc; }

    .admin-msg { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); }
    .admin-msg .modal-ticket-title { color: #10b981; }
    .admin-msg .modal-ticket-text { color: #e5e7eb; }
`;

const styleSheetTickets = document.createElement("style");
styleSheetTickets.innerText = ticketStyles;
document.head.appendChild(styleSheetTickets);

/**
 * OBSERVADOR DE VISIBILIDAD PARA CARGA AUTOMÁTICA
 */
document.addEventListener('DOMContentLoaded', () => {
    const secMisTickets = document.getElementById('sec-mistickets');
    
    if (secMisTickets) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    if (!secMisTickets.classList.contains('hidden')) {
                        cargarMisTickets();
                    }
                }
            });
        });
        observer.observe(secMisTickets, { attributes: true });
    }
});</script>
</body>
</html>
